<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Block Runner</title>
  <link rel="manifest" href="manifest.json">
<link rel="icon" href="icons/icon.png" type="image/png">
<link rel="apple-touch-icon" href="icons/icon.png">
<meif (player.alive && !player2.alive) {ta name="theme-color" content="#000000">
  <style>
    :root{--bg:#000;--panel:#111;--accent:#0f0;--muted:#999}
    html,body{height:100%;margin:0;background:var(--bg);color:#fff;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;user-select:none;overflow:hidden}
    .screen{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column}
    h1{margin:8px 0;font-size:28px}
    p{margin:6px 0;color:var(--muted)}
    button{background:var(--accent);color:#000;border:none;padding:10px 18px;border-radius:10px;font-size:16px;cursor:pointer}
    canvas{display:block;background:#000;width:100%;height:100%}
    #ui{position:fixed;top:10px;left:0;width:100%;text-align:center;font-size:16px;z-index:5}
    #ui span{background:rgba(0,0,0,0.3);padding:6px 10px;border-radius:8px;margin:0 6px}
    /* –°—Ç–∏–ª—ñ –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—ñ–≤ —Ç–∞ –∫–Ω–æ–ø–∫–∏ –ø–∞—É–∑–∏ */
    #ui .controls { display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 10px; }
    #ui .controls button { padding: 6px 10px; border-radius: 8px; background: rgba(255,255,255,0.1); color: #fff; font-size: 16px; }
    /* –°—Ç–∏–ª—å –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞ –ø–∞—É–∑–∏ */
    .pause-modal { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.7); display: none; align-items: center; justify-content: center; z-index: 55; }
    .pause-content { background: var(--panel); border-radius: 12px; padding: 30px; text-align: center; box-shadow: 0 0 20px rgba(0, 255, 0, 0.2); }
    .pause-content h2 { color: var(--accent); margin-top: 0; }
    .small{font-size:13px;color:var(--muted)}
    .buttons{display:flex;gap:12px;margin-top:12px;flex-wrap:wrap;justify-content:center;}
    /* Console styles */
    .console-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:flex-end;justify-content:center;padding:20px;z-index:50}
    .console{background:#0b0b0b;border:1px solid #222;border-radius:12px;width:100%;max-width:820px;max-height:70vh;display:flex;flex-direction:column;overflow:hidden}
    .console-header{padding:10px 12px;border-bottom:1px solid #111;display:flex;align-items:center;justify-content:space-between}
    .console-body{padding:12px;flex:1;overflow:auto;font-family:monospace;font-size:13px;color:#dcdcdc;background:linear-gradient(180deg,#040404,transparent)}
    .console-input{display:flex;padding:10px;border-top:1px solid #111;background:#050505}
    .console-input input{flex:1;padding:10px;border-radius:8px;border:none;background:#0a0a0a;color:#fff;font-family:monospace;font-size:14px}
    /* –°—Ç–∏–ª—å –¥–ª—è –∫–Ω–æ–ø–∫–∏ ‚Üê (–ù–∞–∑–∞–¥), —â–æ–± –≤–æ–Ω–∞ –≤–∏–≥–ª—è–¥–∞–ª–∞ —è–∫ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞ –∫–Ω–æ–ø–∫–∞ */
    .console-input button{
        margin-left:8px;
        padding:8px 12px;
        border-radius:8px;
        border:none;
        background:var(--accent);
        color:#000;
        cursor:pointer; 
        line-height: 1; 
        transition: opacity 0.1s;
    }
    .console-input button:disabled { opacity: 0.5; cursor: default; }
    
    /* –°—Ç–∏–ª—ñ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞ —Ç–∞ –ø–æ–∑–∏—Ü—ñ–æ–Ω—É–≤–∞–Ω–Ω—è –∫–Ω–æ–ø–∫–∏ */
    .modal{
        position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);
        background:#0b0b0b;border-radius:10px;
        padding:12px; 
        width:90%;max-width:900px;
        max-height:80vh; /* –í–∏–∑–Ω–∞—á–∞—î –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É –≤–∏—Å–æ—Ç—É –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞ */
        overflow:hidden; 
        border:1px solid #222;z-index:60;display:none;
        padding-top: 40px; 
    }
    .modal-header {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        padding: 8px 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #0b0b0b;
        border-bottom: 1px solid #222;
        z-index: 61; 
    }
    .modal pre{
        white-space:pre-wrap;word-break:break-word;
        background:#060606;
        padding:12px;border-radius:8px;
        font-family:monospace;color:#eaeaea;font-size:12px;
        height: 100%; /* –ó–∞–±–µ–∑–ø–µ—á—É—î, —â–æ pre –∑–∞–π–º–∞—î –≤—Å—é –¥–æ—Å—Ç—É–ø–Ω—É –≤–∏—Å–æ—Ç—É */
        overflow-y: auto; /* –í–º–∏–∫–∞—î –ø—Ä–æ–∫—Ä—É—Ç–∫—É, —è–∫—â–æ –≤–º—ñ—Å—Ç –±—ñ–ª—å—à–∏–π –∑–∞ –≤–∏—Å–æ—Ç—É */
    }
    .modal .modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:8px; padding: 0 12px 12px 12px;} 
    .tag{font-size:12px;padding:6px 10px;border-radius:999px;cursor: pointer;}
    .small-muted{font-size:12px;color:var(--muted)}
    
    /* –°—Ç–∏–ª—å –¥–ª—è –±—ñ–ª–æ—ó –∫–Ω–æ–ø–∫–∏ –∑–∞–∫—Ä–∏—Ç—Ç—è */
    #closeCodeModal, #closeHelpModal {
      background: white; 
      color: #000; 
      border: 1px solid #000;
      font-weight: bold;
    }

    /* –°—Ç–∏–ª—å –¥–ª—è –∫–Ω–æ–ø–æ–∫ –≤ modal-actions (—è–∫—â–æ –≤–æ–Ω–∏ –∑–∞–ª–∏—à–∏–ª–∏—Å—è) */
    .modal-actions .tag {
        background: rgba(255,255,255,0.03);
        color: #fff;
        border: 1px solid rgba(255,255,255,0.03);
    }
    
    /* –î–æ–¥–∞—Ç–∫–æ–≤–∏–π —Å—Ç–∏–ª—å –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞ –î–æ–≤—ñ–¥–∫–∏ */
    #helpModal .help-item { margin-bottom: 15px; border-left: 3px solid var(--accent); padding-left: 10px; }
    #helpModal .help-item strong { color: var(--accent); }
    
    /* –í–ò–ü–†–ê–í–õ–ï–ù–û: –î–æ–¥–∞–Ω–æ —Ñ—ñ–∫—Å–æ–≤–∞–Ω—É –≤–∏—Å–æ—Ç—É –¥–ª—è –ø—Ä–æ–∫—Ä—É—á—É–≤–∞–Ω–Ω—è –≤–º—ñ—Å—Ç—É –∫–æ–¥—É */
    #codeModalContent { 
      height: 100%; 
      overflow-y: auto; /* –ù–∞—Å–ø—Ä–∞–≤–¥—ñ —Ü–µ –¥—É–±–ª—é—î—Ç—å—Å—è –≤ .modal pre, –∞–ª–µ –∑–∞–±–µ–∑–ø–µ—á—É—î –±–µ–∑–ø–µ–∫—É */
      padding: 12px; /* –î–æ–¥–∞—î–º–æ –≤–Ω—É—Ç—Ä—ñ—à–Ω—ñ–π –≤—ñ–¥—Å—Ç—É–ø, —â–æ–± –≤–º—ñ—Å—Ç –Ω–µ –ø—Ä–∏–ª–∏–ø–∞–≤ –¥–æ –∫—Ä–∞—ó–≤ */
    }
    
    /* –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –≤–∏—Å–æ—Ç—É –¥–ª—è –±–∞—Ç—å–∫—ñ–≤—Å—å–∫–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –∫–æ–¥—É –≤ modal-body */
    #codeModal {
        display: flex; /* –ü–µ—Ä–µ—Ç–≤–æ—Ä—é—î–º–æ –Ω–∞ flex-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫—Ä–∞—â–æ–≥–æ –∫–µ—Ä—É–≤–∞–Ω–Ω—è –≤–∏—Å–æ—Ç–æ—é */
        flex-direction: column; 
    }
    #codeModalContent {
        flex-grow: 1; /* –î–æ–∑–≤–æ–ª—è—î –∫–æ–Ω—Ç–µ–Ω—Ç—É –∑–∞–π–º–∞—Ç–∏ –≤–µ—Å—å –¥–æ—Å—Ç—É–ø–Ω–∏–π –ø—Ä–æ—Å—Ç—ñ—Ä */
        min-height: 0; /* –í–∏—Ä—ñ—à—É—î –ø—Ä–æ–±–ª–µ–º–∏ –∑ flex */
        padding-top: 0; /* –ü—Ä–∏–±–∏—Ä–∞—î–º–æ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç –∑ padding-top –º–æ–¥–∞–ª—É */
    }

    /* –ê–Ω—ñ–º–∞—Ü—ñ—ó –¥–ª—è –Ω–æ–≤–∏—Ö –µ–ª–µ–º–µ–Ω—Ç—ñ–≤ */
    @keyframes spawn {
        0% { transform: scale(0); opacity: 0; }
        70% { transform: scale(1.1); opacity: 1; }
        100% { transform: scale(1); opacity: 1; }
    }

    .bonus {
        animation: spawn 0.3s ease-out;
    }

    .enemy {
        animation: spawn 0.4s ease-out;
    }

    /* –°—Ç–∏–ª—ñ –¥–ª—è —Ä—ñ–≤–Ω—ñ–≤ —Å–∫–ª–∞–¥–Ω–æ—Å—Ç—ñ */
    .level-indicator {
        position: fixed;
        top: 60px;
        right: 10px;
        background: rgba(0, 0, 0, 0.5);
        padding: 5px 10px;
        border-radius: 8px;
        font-size: 12px;
        z-index: 5;
    }

    /* –°—Ç–∏–ª—å –¥–ª—è –∫–Ω–æ–ø–∫–∏ –±–æ—Ç–∞ */
    .bot-btn {
        background: #ff4444;
        color: white;
    }
    .bot-btn.active {
        background: #44ff44;
        color: black;
    }

    /* –°—Ç–∏–ª—ñ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å */
    .settings-modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.8);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 70;
    }
    .settings-content {
        background: var(--panel);
        border-radius: 12px;
        padding: 20px;
        width: 90%;
        max-width: 400px;
        max-height: 80vh;
        overflow-y: auto;
    }
    .settings-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 15px 0;
        padding: 10px;
        background: rgba(255,255,255,0.05);
        border-radius: 8px;
    }
    .toggle-switch {
        position: relative;
        width: 40px;
        height: 20px;
    }
    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }
    .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #333;
        transition: .4s;
        border-radius: 20px;
    }
    .toggle-slider:before {
        position: absolute;
        content: "";
        height: 16px;
        width: 16px;
        left: 2px;
        bottom: 2px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
    }
    input:checked + .toggle-slider {
        background-color: var(--accent);
    }
    input:checked + .toggle-slider:before {
        transform: translateX(130px);
    }
    .language-select {
        background: #333;
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 6px;
        cursor: pointer;
    }
    
.repo-btn {
    position: fixed;
    top: 10px;
    right: 10px;
    background: var(--accent);
    color: #000;
    padding: 8px 14px;
    font-size: 14px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    z-index: 100;
}
.repo-btn:hover {
    opacity: 0.8;
}
   .two-player-btn {
    background: #8844ff;
    color: white;
}
.two-player-btn.active {
    background: #44ff88;
    color: black;
}

#score2 {
    color: #ffaa44;
}

.player-indicator {
    position: fixed;
    top: 90px;
    left: 10px;
    background: rgba(0, 0, 0, 0.5);
    padding: 5px 10px;
    border-radius: 8px;
    font-size: 12px;
    z-index: 5;
}

/* –ù–û–í–Ü –°–¢–ò–õ–Ü –î–õ–Ø –î–û–î–ê–ù–ò–• –°–ò–°–¢–ï–ú */
.coins-display {
    position: fixed;
    top: 10px;
    left: 10px;
    background: rgba(0, 0, 0, 0.7);
    padding: 8px 15px;
    border-radius: 10px;
    font-size: 14px;
    z-index: 5;
    display: flex;
    align-items: center;
    gap: 6px;
}

.revival-modal {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.85);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 80;
}

.revival-content {
    background: var(--panel);
    border-radius: 15px;
    padding: 25px;
    text-align: center;
    max-width: 400px;
    width: 90%;
}

.revival-timer {
    font-size: 24px;
    margin: 15px 0;
    color: var(--accent);
}

.revival-cost {
    margin: 15px 0;
    font-size: 18px;
}

.revival-remaining {
    margin-top: 10px;
    color: var(--muted);
    font-size: 14px;
}

.export-btn, .import-btn {
    background: #4444ff;
    color: white;
}

.quests-btn {
    background: #ff8844;
    color: white;
}

.quests-modal {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.85);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 85;
}

.quests-content {
    background: var(--panel);
    border-radius: 15px;
    padding: 20px;
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
}

.quest-item {
    background: rgba(255,255,255,0.05);
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 10px;
    border-left: 4px solid var(--accent);
}

.quest-progress {
    margin-top: 8px;
    background: rgba(255,255,255,0.1);
    border-radius: 5px;
    height: 6px;
    overflow: hidden;
}

.quest-progress-bar {
    height: 100%;
    background: var(--accent);
    transition: width 0.3s;
}

.quest-reward {
    margin-top: 8px;
    font-size: 14px;
    color: #ffd700;
}

.pwa-warning {
    background: rgba(255, 100, 100, 0.2);
    border: 1px solid #f44;
    padding: 10px;
    border-radius: 8px;
    margin: 10px 0;
}

.moneta {
    animation: spawn 0.4s ease-out;
    animation: float 3s ease-in-out infinite;
}

@keyframes float {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-5px); }
}

button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.fps-counter {
    position: fixed;
    bottom: 10px;
    right: 10px;
    background: rgba(0, 0, 0, 0.5);
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 11px;
    font-family: monospace;
    color: #0f0;
    z-index: 5;
}

/* –°—Ç–∏–ª—ñ –¥–ª—è WebRTC –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞ */
.rtc-modal {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.85);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 200;
}

.rtc-content {
    background: #0b0b0b;
    padding: 20px;
    border-radius: 12px;
    max-width: 500px;
    width: 95%;
    color: #fff;
    border: 1px solid #222;
}

.rtc-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid #222;
}

.rtc-controls {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-bottom: 15px;
    justify-content: center;
}

.rtc-controls button {
    background: #333;
    color: white;
    border: none;
    padding: 10px 15px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    transition: background 0.2s;
    min-width: 120px;
}

.rtc-controls button:hover {
    background: #444;
}

.rtc-controls button:active {
    background: #555;
}

.rtc-code-display {
    text-align: center;
    margin: 20px 0;
    padding: 20px;
    background: rgba(255,255,255,0.05);
    border-radius: 10px;
}

.rtc-code {
    font-size: 48px;
    font-weight: bold;
    letter-spacing: 5px;
    color: var(--accent);
    margin: 15px 0;
    font-family: monospace;
    background: rgba(0,0,0,0.5);
    padding: 15px;
    border-radius: 8px;
    border: 2px dashed var(--accent);
}

.rtc-input-container {
    margin: 20px 0;
    text-align: center;
}

.rtc-input {
    font-size: 24px;
    padding: 15px;
    width: 200px;
    text-align: center;
    letter-spacing: 5px;
    border: 2px solid var(--accent);
    background: rgba(0,0,0,0.5);
    color: var(--accent);
    border-radius: 8px;
    margin-bottom: 10px;
    font-family: monospace;
}

.rtc-status {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
    padding: 10px;
    background: rgba(255,255,255,0.05);
    border-radius: 8px;
    justify-content: center;
}

.rtc-instruction {
    font-size: 12px;
    color: #999;
    margin-top: 15px;
    line-height: 1.4;
    text-align: center;
}

.online-btn {
    background: #0088ff;
    color: white;
}

.online-btn.active {
    background: #00ff88;
    color: black;
}
  </style>
</head>
<body>
  <a href="https://github.com/redel1290/APK/tree/main" target="_blank">
    <button id="repoBtn" class="repo-btn">APK –≤–µ—Ä—Å—ñ—è –≥—Ä–∏</button>
</a>

  <!-- –ê—É–¥—ñ–æ –µ–ª–µ–º–µ–Ω—Ç–∏ -->
  <audio id="menuMusic" loop>
    <source src="music/menu.mp3" type="audio/mpeg">
    –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î –∞—É–¥—ñ–æ –µ–ª–µ–º–µ–Ω—Ç.
  </audio>
  
  <audio id="gameMusic" loop>
    <source src="music/game.mp3" type="audio/mpeg">
    –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î –∞—É–¥—ñ–æ –µ–ª–µ–º–µ–Ω—Ç.
  </audio>

  <div id="menu" class="screen">
    <h1>üü¶ Block Runner</h1>
    <div class="coins-display">
      <span>ü™ô</span>
      <span id="coinsDisplay">0</span>
    </div>
    <p>–£–Ω–∏–∫–∞–π —á–µ—Ä–≤–æ–Ω–∏—Ö –≤–æ—Ä–æ–≥—ñ–≤</p>  
<div class="buttons">
  <button id="startBtn">‚ñ∂ –ü–æ—á–∞—Ç–∏</button>
  <button id="howBtn">‚ùî –Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è</button>
  <button id="botBtn" class="bot-btn">ü§ñ –ë–æ—Ç: –í–ò–ú–ö</button>
  <!-- –ö–Ω–æ–ø–∫–∞ —Å—Ç–≤–æ—Ä–∏—Ç—å—Å—è –¥–∏–Ω–∞–º—ñ—á–Ω–æ —á–µ—Ä–µ–∑ JS -->
  <button id="settingsBtn">‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</button>
  <button id="resetBtn">üóëÔ∏è –°–∫–∏–Ω—É—Ç–∏ –ø—Ä–æ–≥—Ä–µ—Å</button>
  <button id="onlineBtn" class="online-btn">üîó –û–Ω–ª–∞–π–Ω</button>
</div>
    <p class="small">–†–µ–∫–æ—Ä–¥: <strong id="bestMenu">0</strong> | –û—á–∫–∏: <strong id="scoreMenu">0</strong></p>
  </div>

  <div id="gameScreen" class="screen" style="display:none">
    <canvas id="game"></canvas>
    <div id="ui">
      <div class="controls">
        <span>–ß–∞—Å: <span id="time">0</span></span>
        <span>–†–µ–∫–æ—Ä–¥: <span id="best">0</span></span>
        <span>–û—á–∫–∏: <span id="score">0</span></span>
        <button id="pauseBtn">‚è∏Ô∏è</button>
      </div>
    </div>
    <div class="level-indicator">–†—ñ–≤–µ–Ω—å: <span id="level">1</span></div>
    <div class="fps-counter" id="fpsCounter">FPS: 0</div>
  </div>

  <div id="gameOver" class="screen" style="display:none;">
    <h1>üíÄ –ì—Ä—É –∑–∞–∫—ñ–Ω—á–µ–Ω–æ!</h1>
    <p>–í–∞—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç: <strong id="scoreOut">0</strong> —Å</p>
    <p>–û—á–∫–∏: <strong id="finalScore">0</strong></p>
    <p class="small">–†–µ–∫–æ—Ä–¥: <strong id="bestOut">0</strong> —Å</p>
    <div class="buttons">
      <button id="retryBtn">üîÅ –°–ø—Ä–æ–±—É–≤–∞—Ç–∏ —â–µ —Ä–∞–∑</button>
      <button id="menuBtn">üè† –ú–µ–Ω—é</button>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å -->
  <div id="settingsModal" class="settings-modal" aria-hidden="true">
    <div class="settings-content" role="dialog" aria-modal="true" aria-label="–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –≥—Ä–∏">
      <h2 style="text-align: center; margin-top: 0; color: var(--accent);">‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</h2>
      
      <div class="settings-item">
        <label for="languageSelect">üåê –ú–æ–≤–∞:</label>
        <select id="languageSelect" class="language-select">
          <option value="uk">–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞</option>
          <option value="en">English</option>
        </select>
      </div>
      
      <div class="settings-item">
        <label for="fps-select">üéÆ FPS –õ—ñ–º—ñ—Ç</label>
        <select id="fps-select" class="language-select">
          <option value="30">30 FPS</option>
          <option value="60" selected>60 FPS</option>
          <option value="90">90 FPS</option>
          <option value="120">120 FPS</option>
          <option value="144">144 FPS</option>
          <option value="190">190 FPS</option>
        </select>
      </div>
      
      <div class="settings-item">
        <label for="menuMusicToggle">üéµ –ú—É–∑–∏–∫–∞ –≤ –º–µ–Ω—é</label>
        <label class="toggle-switch">
          <input type="checkbox" id="menuMusicToggle" checked>
          <span class="toggle-slider"></span>
        </label>
      </div>
      
      <div class="settings-item">
        <label for="gameMusicToggle">üéµ –ú—É–∑–∏–∫–∞ –≤ –≥—Ä—ñ</label>
        <label class="toggle-switch">
          <input type="checkbox" id="gameMusicToggle" checked>
          <span class="toggle-slider"></span>
        </label>
      </div>
      
      <div class="settings-item">
        <label for="vibrationToggle">üì≥ –í—ñ–±—Ä–∞—Ü—ñ—è</label>
        <label class="toggle-switch">
          <input type="checkbox" id="vibrationToggle" checked>
          <span class="toggle-slider"></span>
        </label>
      </div>
      
      <div class="buttons" style="margin-top: 20px; display: flex; gap: 10px;">
        <button id="exportBtn" class="export-btn" style="flex: 1;">üì§ –ï–∫—Å–ø–æ—Ä—Ç</button>
        <button id="importBtn" class="import-btn" style="flex: 1;">üì• –Ü–º–ø–æ—Ä—Ç</button>
      </div>
      
      <div class="buttons" style="margin-top: 20px;">
        <button id="closeSettingsBtn">‚úÖ –ì–æ—Ç–æ–≤–æ</button>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –≤—ñ–¥—Ä–æ–¥–∂–µ–Ω–Ω—è -->
  <div id="revivalModal" class="revival-modal" aria-hidden="true">
    <div class="revival-content" role="dialog" aria-modal="true" aria-label="–í—ñ–¥—Ä–æ–¥–∂–µ–Ω–Ω—è">
      <h2 style="color: var(--accent);">üîÑ –í—ñ–¥—Ä–æ–¥–∏—Ç–∏—Å—è?</h2>
      <p id="revivalDescription">–£ –≤–∞—Å —î 5 —Å–µ–∫—É–Ω–¥, —â–æ–± –ø—Ä–∏–π–Ω—è—Ç–∏ —Ä—ñ—à–µ–Ω–Ω—è</p>
      <div class="revival-timer" id="revivalTimer">5</div>
      <div class="revival-cost">
        –í–∞—Ä—Ç—ñ—Å—Ç—å: <span id="revivalCost">1</span> ü™ô
      </div>
      <div class="buttons">
        <button id="reviveBtn" style="background: #44ff44; color: #000;">–í—ñ–¥—Ä–æ–¥–∏—Ç–∏—Å—è</button>
        <button id="skipRevivalBtn" style="background: #ff4444; color: #fff;">–ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏</button>
      </div>
      <div class="revival-remaining">
        –ó–∞–ª–∏—à–∏–ª–æ—Å—å –≤—ñ–¥—Ä–æ–¥–∂–µ–Ω—å: <span id="revivalsLeft">3</span>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –∫–≤–µ—Å—Ç—ñ–≤ -->
  <div id="questsModal" class="quests-modal" aria-hidden="true">
    <div class="quests-content" role="dialog" aria-modal="true" aria-label="–ö–≤–µ—Å—Ç–∏">
      <div class="modal-header">
        <h2 style="margin:0; color:var(--accent);">üéØ –ö–≤–µ—Å—Ç–∏</h2>
        <div><button id="closeQuestsModal" class="tag">‚Üê –ù–∞–∑–∞–¥</button></div>
      </div>
      <div id="questsList">
        <!-- –ö–≤–µ—Å—Ç–∏ –±—É–¥—É—Ç—å –¥–∏–Ω–∞–º—ñ—á–Ω–æ –¥–æ–¥–∞–Ω—ñ -->
      </div>
      <div id="pwaWarning" class="pwa-warning" style="display: none;">
        <p>‚ö†Ô∏è –ö–≤–µ—Å—Ç–∏ –¥–æ—Å—Ç—É–ø–Ω—ñ —Ç—ñ–ª—å–∫–∏ —É –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ñ–π –≤–µ—Ä—Å—ñ—ó –≥—Ä–∏ (PWA –∞–±–æ APK)</p>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ WebRTC –æ–Ω–ª–∞–π–Ω –∑ –ø—Ä–æ—Å—Ç–∏–º–∏ –∫–æ–¥–∞–º–∏ -->
  <div id="rtcModal" class="rtc-modal" aria-hidden="true">
    <div class="rtc-content" role="dialog" aria-modal="true" aria-label="–û–Ω–ª–∞–π–Ω –≥—Ä–∞ WebRTC">
      <div class="rtc-header">
        <strong style="color: var(--accent); font-size: 18px;">üîó –û–Ω–ª–∞–π–Ω –≥—Ä–∞ (–ü—Ä–æ—Å—Ç–∞ –≤–µ—Ä—Å—ñ—è)</strong>
        <button id="closeRtc" style="background:#fff;color:#000;border:none;padding:6px 10px;border-radius:8px;cursor:pointer;">‚úï –ó–∞–∫—Ä–∏—Ç–∏</button>
      </div>
      
      <div id="hostPanel" style="display: none;">
        <div class="rtc-code-display">
          <p>–í–∞—à –∫–æ–¥ –∫—ñ–º–Ω–∞—Ç–∏:</p>
          <div class="rtc-code" id="roomCode">000000</div>
          <p>–î–∞–π—Ç–µ —Ü–µ–π –∫–æ–¥ —ñ–Ω—à–æ–º—É –≥—Ä–∞–≤—Ü—é</p>
        </div>
        
        <div class="rtc-controls">
          <button id="copyRoomCodeBtn">üìã –ö–æ–ø—ñ—é–≤–∞—Ç–∏ –∫–æ–¥</button>
          <button id="startGameAsHostBtn">‚ñ∂ –ü–æ—á–∞—Ç–∏ –≥—Ä—É</button>
        </div>
      </div>
      
      <div id="joinPanel" style="display: none;">
        <div class="rtc-input-container">
          <p>–í–≤–µ–¥—ñ—Ç—å –∫–æ–¥ –∫—ñ–º–Ω–∞—Ç–∏:</p>
          <input type="text" id="joinCodeInput" class="rtc-input" maxlength="6" placeholder="000000">
          <button id="joinRoomBtn">üîå –ü—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—å</button>
        </div>
      </div>
      
      <div id="mainPanel">
        <div class="rtc-controls">
          <button id="createRoomBtn">‚ú® –°—Ç–≤–æ—Ä–∏—Ç–∏ –∫—ñ–º–Ω–∞—Ç—É</button>
          <button id="joinRoomMainBtn">üîå –ü—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—å –¥–æ –∫—ñ–º–Ω–∞—Ç–∏</button>
        </div>
        
        <div class="rtc-status">
          <span id="rtcStatus" style="color: #ff6b6b;">üî¥ –ù–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ</span>
          <span id="rtcPeerInfo" style="color: #999; font-size: 14px;">–û–±–µ—Ä—ñ—Ç—å –¥—ñ—é</span>
        </div>
        
        <div class="rtc-controls" style="margin-top: 20px;">
          <button id="sendTestBtn" disabled>‚ñ∂ –¢–µ—Å—Ç –∑'—î–¥–Ω–∞–Ω–Ω—è</button>
          <button id="disconnectBtn" disabled>üîå –í—ñ–¥–∫–ª—é—á–∏—Ç–∏—Å—å</button>
        </div>
      </div>
      
      <div class="rtc-instruction">
        <p><strong>üìñ –Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è:</strong></p>
        <p>1. <strong>–°—Ç–≤–æ—Ä—ñ—Ç—å –∫—ñ–º–Ω–∞—Ç—É</strong> —Ç–∞ –¥–∞–π—Ç–µ 6-–∑–Ω–∞—á–Ω–∏–π –∫–æ–¥ —ñ–Ω—à–æ–º—É –≥—Ä–∞–≤—Ü—é</p>
        <p>2. <strong>–ü—Ä–∏—î–¥–Ω–∞–π—Ç–µ—Å—å</strong> –¥–æ –∫—ñ–º–Ω–∞—Ç–∏, –≤–≤—ñ–≤—à–∏ –∫–æ–¥ –≤—ñ–¥ —ñ–Ω—à–æ–≥–æ –≥—Ä–∞–≤—Ü—è</p>
        <p>3. <strong>–û—á—ñ–∫—É–π—Ç–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è</strong> - –≤–æ–Ω–æ –≤—ñ–¥–±—É–¥–µ—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ</p>
        <p>4. <strong>–ü–æ—á–∏–Ω–∞–π—Ç–µ –≥—Ä—É –æ–¥–Ω–æ—á–∞—Å–Ω–æ!</strong></p>
      </div>
    </div>
  </div>

  <div id="pauseModal" class="pause-modal" aria-hidden="true">
    <div class="pause-content" role="dialog" aria-modal="true" aria-label="–ì—Ä–∞ –Ω–∞ –ø–∞—É–∑—ñ">
      <h2>‚è∏Ô∏è –ü–∞—É–∑–∞</h2>
      <p>–ì—Ä–∞ –ø—Ä–∏–∑—É–ø–∏–Ω–µ–Ω–∞.</p>
      <div class="buttons">
        <button id="resumeBtn">‚ñ∂ –ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏</button>
        <button id="pauseMenuBtn">üè† –£ –º–µ–Ω—é</button>
      </div>
      <p class="small" style="margin-top: 15px;">–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å Esc –∞–±–æ –∫–Ω–æ–ø–∫—É "–ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏"</p>
    </div>
  </div>

  <div id="consoleOverlay" class="console-overlay" aria-hidden="true">
    <div class="console" role="dialog" aria-label="–ö–æ–º–∞–Ω–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞ –≥—Ä–∏">
      <div class="console-header">
        <div><span class="tag">Game Console</span> <span class="small-muted" id="consoleStatus">system ready</span></div>
        <div>
          <button id="closeConsoleBtn" class="tag" style="cursor:pointer">–ó–∞–∫—Ä–∏—Ç–∏</button>
        </div>
      </div>
      <div id="consoleBody" class="console-body"></div>
      <div class="console-input">
        <button id="consoleBackBtn" title="–ù–∞–∑–∞–¥ / –ó–∞–∫—Ä–∏—Ç–∏ –∫–æ–Ω—Å–æ–ª—å" style="background: #333; color: #fff; margin-right: 8px;">‚Üê</button>
        <input id="consoleInput" placeholder="–í–≤–µ–¥—ñ—Ç—å –∫–æ–º–∞–Ω–¥—É, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥ /help" />
        <button id="consoleSend">–í–∏–∫–æ–Ω–∞—Ç–∏</button>
      </div>
    </div>
  </div>

  <div id="codeModal" class="modal" role="dialog" aria-label="–ö–æ–¥ –≥—Ä–∏">
    <div class="modal-header">
      <strong>–ü–æ–≤–Ω–∏–π –∫–æ–¥ –≥—Ä–∏ (–ü–∞—Ä–æ–ª—å –ø—Ä–∏–π–Ω—è—Ç–æ)</strong>
      <div><button id="closeCodeModal" class="tag">–ó–∞–∫—Ä–∏—Ç–∏</button></div> 
    </div>

    <div id="codeModalContent">
      <pre id="codePre"></pre>
    </div>
  </div>

  <div id="helpModal" class="modal" role="dialog" aria-label="–î–æ–≤—ñ–¥–∫–∞ –ø–æ –∫–æ–º–∞–Ω–¥–Ω—ñ–π —Å—Ç—Ä–æ—Ü—ñ" style="padding-top: 50px;">
    <div class="modal-header">
        <h2 style="margin:0; color:var(--accent); font-size: 16px;">–î–æ–≤—ñ–¥–∫–∞ –ø–æ –ö–æ–Ω—Å–æ–ª—ñ</h2>
        <div><button id="closeHelpModal" class="tag">–ó–∞–∫—Ä–∏—Ç–∏</button></div>
    </div>
    <div style="padding: 12px; height: 100%; overflow-y: auto;">
        <div class="help-item">
            <strong>/code</strong>
            <p>–ü–æ–∫–∞–∑—É—î –ø–æ–≤–Ω–∏–π –≤–∏—Ö—ñ–¥–Ω–∏–π –∫–æ–¥ –≥—Ä–∏.</p>
        </div>
        <div class="help-item">
            <strong>/god on | /god off</strong>
            <p>–í–º–∏–∫–∞—î –∞–±–æ –≤–∏–º–∏–∫–∞—î —Ä–µ–∂–∏–º –Ω–µ–ø–µ—Ä–µ–º–æ–∂–Ω–æ—Å—Ç—ñ (God Mode). –£–≤—ñ–º–∫–Ω–µ–Ω–∏–π —Ä–µ–∂–∏–º –¥–æ–∑–≤–æ–ª—è—î –≥—Ä–∞–≤—Ü—é –Ω–µ –ø–æ–º–∏—Ä–∞—Ç–∏ –≤—ñ–¥ –∑—ñ—Ç–∫–Ω–µ–Ω—å —ñ–∑ —á–µ—Ä–≤–æ–Ω–∏–º–∏ –≤–æ—Ä–æ–≥–∞–º–∏.</p>
        </div>
        <div class="help-item">
            <strong>/score</strong>
            <p>–ü–æ–∫–∞–∑—É—î –ø–æ—Ç–æ—á–Ω–∏–π —Ä–∞—Ö—É–Ω–æ–∫.</p>
        </div>
        <div class="help-item">
            <strong>/time</strong>
            <p>–ü–æ–∫–∞–∑—É—î —á–∞—Å –≥—Ä–∏.</p>
        </div>
        <div class="help-item">
            <strong>/enemies</strong>
            <p>–ü–æ–∫–∞–∑—É—î –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–∏—Ö –≤–æ—Ä–æ–≥—ñ–≤.</p>
        </div>
        <div class="help-item">
            <strong>/clear</strong>
            <p>–û—á–∏—â–∞—î –∫–æ–Ω—Å–æ–ª—å.</p>
        </div>
        <div class="help-item">
            <strong>/help</strong>
            <p>–í–∏–≤–æ–¥–∏—Ç—å —Ü–µ –¥–æ–≤—ñ–¥–∫–æ–≤–µ –≤—ñ–∫–Ω–æ (–∑–Ω–∏–∫–Ω–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥).</p>
        </div>
        <div class="help-item">
            <strong>/bb on | /bb off</strong>
            <p>–í–º–∏–∫–∞—î/–≤–∏–º–∏–∫–∞—î –±–æ—Ç–∞-–æ—Ö–æ—Ä–æ–Ω—Ü—è, —è–∫–∏–π –ª—ñ—Ç–∞—î –Ω–∞–≤–∫–æ–ª–æ –≥—Ä–∞–≤—Ü—è —Ç–∞ –∑–Ω–∏—â—É—î –≤–æ—Ä–æ–≥—ñ–≤.</p>
        </div>
        <div class="help-item">
            <strong>/online</strong>
            <p>–í—ñ–¥–∫—Ä–∏–≤–∞—î –ø–∞–Ω–µ–ª—å –¥–ª—è –≥—Ä–∏ –æ–Ω–ª–∞–π–Ω —á–µ—Ä–µ–∑ WebRTC.</p>
        </div>
    </div>
  </div>
<script>
// –ì–õ–û–ë–ê–õ–¨–ù–ê —Å–∏–≥–Ω–∞–ª—å–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ (–≤–∏–Ω–µ—Å–µ–Ω–æ –∑–∞ –º–µ–∂—ñ IIFE)
window.globalSignalingServer = {
  rooms: {},
  
  createRoom(code) {
    console.log('Global Signaling: Creating room', code);
    this.rooms[code] = {
      host: null,
      guest: null,
      messages: []
    };
    return code;
  },
  
  joinRoom(code, peerId) {
    console.log('Global Signaling: Joining room', code, peerId);
    if (!this.rooms[code]) {
      console.log('Global Signaling: Room not found', code);
      return { error: '–ö—ñ–º–Ω–∞—Ç–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞' };
    }
    
    const room = this.rooms[code];
    if (!room.host) {
      room.host = peerId;
      console.log('Global Signaling: Assigned as host');
      return { role: 'host' };
    } else if (!room.guest) {
      room.guest = peerId;
      console.log('Global Signaling: Assigned as guest');
      return { role: 'guest' };
    } else {
      return { error: '–ö—ñ–º–Ω–∞—Ç–∞ –∑–∞–ø–æ–≤–Ω–µ–Ω–∞' };
    }
  },
  
  sendMessage(code, fromPeerId, message) {
    console.log('Global Signaling: Sending message', code, fromPeerId, message.type);
    if (!this.rooms[code]) {
      console.log('Global Signaling: Room not found for send');
      return false;
    }
    
    const room = this.rooms[code];
    room.messages.push({
      from: fromPeerId,
      message: message,
      timestamp: Date.now()
    });
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø–µ—Ä–µ—Å–∏–ª–∞—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —ñ–Ω—à–æ–º—É –ø—ñ—Ä—É
    const targetPeerId = fromPeerId === room.host ? room.guest : room.host;
    if (targetPeerId && window[targetPeerId]) {
      console.log('Global Signaling: Forwarding to', targetPeerId);
      setTimeout(() => {
        if (window[targetPeerId] && typeof window[targetPeerId].receiveMessage === 'function') {
          window[targetPeerId].receiveMessage(message);
        }
      }, 10);
    }
    
    return true;
  },
  
  cleanupRoom(code) {
    console.log('Global Signaling: Cleaning up room', code);
    if (this.rooms[code]) {
      delete this.rooms[code];
    }
  }
};

// –ì–ª–æ–±–∞–ª—å–Ω–∏–π –æ–±—Ä–æ–±–Ω–∏–∫ –¥–ª—è –≤—Å—ñ—Ö –≤–∫–ª–∞–¥–æ–∫
window.peerHandlerGlobal = {
  receiveMessage(message) {
    console.log('Global PeerHandler: Received message', message.type);
    // –ü–µ—Ä–µ—Å–∏–ª–∞—î–º–æ –≤ –æ—Å–Ω–æ–≤–Ω–∏–π –ø–æ—Ç—ñ–∫
    if (window.handleRTCFromGlobal) {
      window.handleRTCFromGlobal(message);
    }
  }
};

(() => {
  /* ------------------ –ï–ª–µ–º–µ–Ω—Ç–∏ DOM ------------------ */
  const menu = document.getElementById('menu');
  const gameScreen = document.getElementById('gameScreen');
  const gameOver = document.getElementById('gameOver');
  const startBtn = document.getElementById('startBtn');
  const howBtn = document.getElementById('howBtn');
  const botBtn = document.getElementById('botBtn');
  const exportBtn = document.getElementById('exportBtn');
  const importBtn = document.getElementById('importBtn');
  const questsBtn = document.getElementById('questsBtn');
  const settingsBtn = document.getElementById('settingsBtn');
  const resetBtn = document.getElementById('resetBtn');
  const onlineBtn = document.getElementById('onlineBtn');
  const retryBtn = document.getElementById('retryBtn');
  const menuBtn = document.getElementById('menuBtn');
  const pauseModal = document.getElementById('pauseModal');
  const pauseBtn = document.getElementById('pauseBtn');
  const resumeBtn = document.getElementById('resumeBtn');
  const pauseMenuBtn = document.getElementById('pauseMenuBtn');
  const menuMusic = document.getElementById('menuMusic');
  const gameMusic = document.getElementById('gameMusic');
  const settingsModal = document.getElementById('settingsModal');
  const closeSettingsBtn = document.getElementById('closeSettingsBtn');
  const languageSelect = document.getElementById('languageSelect');
  const menuMusicToggle = document.getElementById('menuMusicToggle');
  const gameMusicToggle = document.getElementById('gameMusicToggle');
  const vibrationToggle = document.getElementById('vibrationToggle');
  const fpsSelect = document.getElementById('fps-select');
  const fpsCounter = document.getElementById('fpsCounter');
  const coinsDisplay = document.getElementById('coinsDisplay');
  const revivalModal = document.getElementById('revivalModal');
  const revivalTimer = document.getElementById('revivalTimer');
  const revivalCost = document.getElementById('revivalCost');
  const revivalsLeft = document.getElementById('revivalsLeft');
  const reviveBtn = document.getElementById('reviveBtn');
  const skipRevivalBtn = document.getElementById('skipRevivalBtn');
  const revivalDescription = document.getElementById('revivalDescription');
  const questsModal = document.getElementById('questsModal');
  const questsList = document.getElementById('questsList');
  const pwaWarning = document.getElementById('pwaWarning');
  const closeQuestsModal = document.getElementById('closeQuestsModal');

  // WebRTC –µ–ª–µ–º–µ–Ω—Ç–∏ (—Å–ø—Ä–æ—â–µ–Ω–∞ –≤–µ—Ä—Å—ñ—è)
  const rtcModal = document.getElementById('rtcModal');
  const closeRtc = document.getElementById('closeRtc');
  const createRoomBtn = document.getElementById('createRoomBtn');
  const joinRoomMainBtn = document.getElementById('joinRoomMainBtn');
  const hostPanel = document.getElementById('hostPanel');
  const joinPanel = document.getElementById('joinPanel');
  const mainPanel = document.getElementById('mainPanel');
  const roomCodeEl = document.getElementById('roomCode');
  const copyRoomCodeBtn = document.getElementById('copyRoomCodeBtn');
  const startGameAsHostBtn = document.getElementById('startGameAsHostBtn');
  const joinCodeInput = document.getElementById('joinCodeInput');
  const joinRoomBtn = document.getElementById('joinRoomBtn');
  const sendTestBtn = document.getElementById('sendTestBtn');
  const disconnectBtn = document.getElementById('disconnectBtn');
  const rtcStatus = document.getElementById('rtcStatus');
  const rtcPeerInfo = document.getElementById('rtcPeerInfo');

  // –õ—ñ—á–∏–ª—å–Ω–∏–∫–∏ - –∑–±–µ—Ä—ñ–≥–∞—î–º–æ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –µ–ª–µ–º–µ–Ω—Ç–∏
  let bestMenuEl = document.getElementById('bestMenu');
  let scoreMenuEl = document.getElementById('scoreMenu');
  let timeEl = document.getElementById('time');
  let bestEl = document.getElementById('best');
  let scoreEl = document.getElementById('score');
  let scoreOut = document.getElementById('scoreOut');
  let finalScore = document.getElementById('finalScore');
  let bestOut = document.getElementById('bestOut');
  let levelEl = document.getElementById('level');

  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  
  // –ï–ª–µ–º–µ–Ω—Ç–∏ –∫–æ–Ω—Å–æ–ª—ñ —Ç–∞ –º–æ–¥–∞–ª—å–Ω–∏—Ö –≤—ñ–∫–æ–Ω
  const consoleOverlay = document.getElementById('consoleOverlay');
  const consoleBody = document.getElementById('consoleBody');
  const consoleInput = document.getElementById('consoleInput');
  const consoleSend = document.getElementById('consoleSend');
  const closeConsoleBtn = document.getElementById('closeConsoleBtn');
  const consoleBackBtn = document.getElementById('consoleBackBtn'); 
  const consoleStatus = document.getElementById('consoleStatus');
  const codeModal = document.getElementById('codeModal');
  const codePre = document.getElementById('codePre');
  const closeCodeModal = document.getElementById('closeCodeModal'); 
  const helpModal = document.getElementById('helpModal'); 
  const closeHelpModal = document.getElementById('closeHelpModal'); 

  /* ------------------ –ó–º—ñ–Ω–Ω—ñ —Ç–∞ —Å—Ç–∞–Ω –≥—Ä–∏ ------------------ */
  let width = innerWidth, height = innerHeight;
  let animationId = null;
  let timeTimer = null;
  let spawnTimer = null;
  let bonusTimer = null;
  let powerupTimer = null;
  let coinTimer = null;
  let timeSec = 0;
  let enemies = [];
  let bonuses = [];
  let coins = []; // –ù–û–í–ê –ó–ú–Ü–ù–ù–ê: –º–∞—Å–∏–≤ –º–æ–Ω–µ—Ç
  let aiBot = { x: 100, y: 100, size: 30, speed: 1 };
  let bodyguardBot = { x: 0, y: 0, size: 25, speed: 2, angle: 0, active: false };
  let keys = {};
  let best = parseInt(localStorage.getItem('bestTime')) || 0;
  let bestScore = parseInt(localStorage.getItem('bestScore')) || 0;
  let particles = [];
  let stars = [];
  let score = 0;
  let level = 1;
  let enemySpawnRate = 1000;
  let botEnabled = false;
  let menuMusicEnabled = true;
  let gameMusicEnabled = true;
  let vibrationEnabled = true;
  let currentLanguage = 'uk';
  let lastTime = 0;
  let fpsScale = 60; // –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º
  let fpsLimit = 60; // —Ä–µ–∞–ª—å–Ω–∏–π FPS –ª—ñ–º—ñ—Ç
  let frameCount = 0;
  let lastFpsUpdate = 0;
  let fps = 0;
  
  // –ù–û–í–Ü –ó–ú–Ü–ù–ù–Ü –î–õ–Ø –ù–û–í–ò–• –°–ò–°–¢–ï–ú
  let coinsAmount = parseInt(localStorage.getItem('coins')) || 0;
  let revivalsRemaining = 3;
  let revivalPrice = 1;
  let revivalTimerId = null;
  let revivalSeconds = 5;
  let waitingForRevival = false;
  let deadPlayers = []; // –ú–∞—Å–∏–≤ –º–µ—Ä—Ç–≤–∏—Ö –≥—Ä–∞–≤—Ü—ñ–≤ (–º–æ–∂–µ –º—ñ—Å—Ç–∏—Ç–∏ –æ–¥–Ω–æ–≥–æ –∞–±–æ –¥–≤–æ—Ö)
  let isPWA = false;
  
  // –ù–û–í–Ü –ó–ú–Ü–ù–ù–Ü –î–õ–Ø –î–í–û–• –ì–†–ê–í–¶–Ü–í
  let twoPlayerMode = false;
  let player2 = {x: 0, y: 0, size: 30, speed: 4, alive: true};
  let score2 = 0;
  let twoPlayerBtn = null; // –ë—É–¥–µ —Å—Ç–≤–æ—Ä–µ–Ω–æ –¥–∏–Ω–∞–º—ñ—á–Ω–æ
  
  // WebRTC –∑–º—ñ–Ω–Ω—ñ (—Å–ø—Ä–æ—â–µ–Ω—ñ)
  let peerConnection = null;
  let dataChannel = null;
  let isHost = false;
  let isConnected = false;
  let lastSentState = 0;
  let peerState = {
    player: { x: 0, y: 0, size: 30, alive: true, score: 0 },
    gameActive: false,
    gamePaused: false,
    timeSec: 0
  };
  
  // –°–ø—Ä–æ—â–µ–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –∫—ñ–º–Ω–∞—Ç
  let roomCode = '';
  let signalingServer = null; // –°–ø—Ä–æ—â–µ–Ω–∏–π —Å–∏–≥–Ω–∞–ª—å–Ω–∏–π —Å–µ—Ä–≤–µ—Ä
  
  // –ü—Ä–∞–ø–æ—Ä—Ü—ñ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ –≤—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è
  let musicAutoplayAttempted = false;
  
  // –ö–ª—é—á –¥–ª—è —à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è
    const ENCRYPTION_KEY = String.fromCharCode(
    98,108,111,99,107,45,114,117,110,110,101,114,45,115,101,99,114,101,116,45,50,48,50,52
);
  // –°–ª–æ–≤–Ω–∏–∫–∏ –¥–ª—è –ø–µ—Ä–µ–∫–ª–∞–¥—ñ–≤
  const translations = {
    uk: {
      title: "Block Runner ‚Äî –ü–æ–∫—Ä–∞—â–µ–Ω–∞ –í–µ—Ä—Å—ñ—è",
      gameTitle: "üü¶ Block Runner",
      gameSubtitle: "–£–Ω–∏–∫–∞–π —á–µ—Ä–≤–æ–Ω–∏—Ö –≤–æ—Ä–æ–≥—ñ–≤",
      startBtn: "‚ñ∂ –ü–æ—á–∞—Ç–∏",
      howBtn: "‚ùî –Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è",
      botBtnOn: "ü§ñ –ë–æ—Ç: –£–í–Ü–ú–ö",
      botBtnOff: "ü§ñ –ë–æ—Ç: –í–ò–ú–ö",
      twoPlayerBtnOn: "üë• –î–≤–∞ –≥—Ä–∞–≤—Ü—ñ: –£–í–Ü–ú–ö",
      twoPlayerBtnOff: "üë• –î–≤–∞ –≥—Ä–∞–≤—Ü—ñ: –í–ò–ú–ö",
      exportBtn: "üì§ –ï–∫—Å–ø–æ—Ä—Ç",
      importBtn: "üì• –Ü–º–ø–æ—Ä—Ç",
      questsBtn: "üéØ –ö–≤–µ—Å—Ç–∏",
      settingsBtn: "‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è",
      resetBtn: "üóëÔ∏è –°–∫–∏–Ω—É—Ç–∏ –ø—Ä–æ–≥—Ä–µ—Å",
      onlineBtn: "üîó –û–Ω–ª–∞–π–Ω",
      onlineBtnConnected: "üîó –û–Ω–ª–∞–π–Ω (–ü—ñ–¥–∫–ª—é—á–µ–Ω–æ)",
      bestRecord: "–†–µ–∫–æ—Ä–¥",
      points: "–û—á–∫–∏",
      time: "–ß–∞—Å",
      level: "–†—ñ–≤–µ–Ω—å",
      gameOver: "üíÄ –ì—Ä—É –∑–∞–∫—ñ–Ω—á–µ–Ω–æ!",
      yourScore: "–í–∞—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç",
      seconds: "—Å",
      retryBtn: "üîÅ –°–ø—Ä–æ–±—É–≤–∞—Ç–∏ —â–µ —Ä–∞–∑",
      menuBtn: "üè† –ú–µ–Ω—é",
      pause: "‚è∏Ô∏è –ü–∞—É–∑–∞",
      gamePaused: "–ì—Ä–∞ –ø—Ä–∏–∑—É–ø–∏–Ω–µ–Ω–∞.",
      resumeBtn: "‚ñ∂ –ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏",
      pauseMenuBtn: "üè† –£ –º–µ–Ω—é",
      pressEsc: "–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å Esc –∞–±–æ –∫–Ω–æ–ø–∫—É '–ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏'",
      settingsTitle: "‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è",
      language: "üåê –ú–æ–≤–∞:",
      menuMusic: "üéµ –ú—É–∑–∏–∫–∞ –≤ –º–µ–Ω—é",
      gameMusic: "üéµ –ú—É–∑–∏–∫–∞ –≤ –≥—Ä—ñ",
      vibration: "üì≥ –í—ñ–±—Ä–∞—Ü—ñ—è",
      doneBtn: "‚úÖ –ì–æ—Ç–æ–≤–æ",
      consolePlaceholder: "–í–≤–µ–¥—ñ—Ç—å –∫–æ–º–∞–Ω–¥—É, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥ /help",
      consoleSend: "–í–∏–∫–æ–Ω–∞—Ç–∏",
      close: "–ó–∞–∫—Ä–∏—Ç–∏",
      player1: "–ì—Ä–∞–≤–µ—Ü—å 1",
      player2: "–ì—Ä–∞–≤–µ—Ü—å 2",
      player1Score: "–û—á–∫–∏ 1",
      player2Score: "–û—á–∫–∏ 2",
      coins: "–ú–æ–Ω–µ—Ç–∏",
      revivalTitle: "üîÑ –í—ñ–¥—Ä–æ–¥–∏—Ç–∏—Å—è?",
      revivalDescSingle: "–£ –≤–∞—Å —î 5 —Å–µ–∫—É–Ω–¥, —â–æ–± –ø—Ä–∏–π–Ω—è—Ç–∏ —Ä—ñ—à–µ–Ω–Ω—è",
      revivalDescTwoPlayers: "–í—ñ–¥—Ä–æ–¥–∏—Ç–∏ –¥–≤–æ—Ö –≥—Ä–∞–≤—Ü—ñ–≤? –£ –≤–∞—Å —î 5 —Å–µ–∫—É–Ω–¥",
      reviveBtn: "–í—ñ–¥—Ä–æ–¥–∏—Ç–∏—Å—è",
      skipRevivalBtn: "–ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏",
      revivalsLeftText: "–ó–∞–ª–∏—à–∏–ª–æ—Å—å –≤—ñ–¥—Ä–æ–¥–∂–µ–Ω—å:",
      cost: "–í–∞—Ä—Ç—ñ—Å—Ç—å:",
      questsTitle: "üéØ –ö–≤–µ—Å—Ç–∏",
      pwaWarning: "‚ö†Ô∏è –ö–≤–µ—Å—Ç–∏ –¥–æ—Å—Ç—É–ø–Ω—ñ —Ç—ñ–ª—å–∫–∏ —É –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ñ–π –≤–µ—Ä—Å—ñ—ó –≥—Ä–∏ (PWA –∞–±–æ APK)",
      backBtn: "‚Üê –ù–∞–∑–∞–¥",
      fpsLimit: "üéÆ FPS –õ—ñ–º—ñ—Ç",
      rtcConnected: "üü¢ –ü—ñ–¥–∫–ª—é—á–µ–Ω–æ –¥–æ —ñ–Ω—à–æ–≥–æ –≥—Ä–∞–≤—Ü—è",
      rtcConnecting: "üü° –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è...",
      rtcDisconnected: "üî¥ –ù–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ",
      rtcHost: "–•–æ—Å—Ç",
      rtcGuest: "–ì—ñ—Å—Ç—å"
    },
    en: {
      title: "Block Runner ‚Äî Enhanced Version",
      gameTitle: "üü¶ Block Runner",
      gameSubtitle: "Avoid red enemies",
      startBtn: "‚ñ∂ Start",
      howBtn: "‚ùî Instructions",
      botBtnOn: "ü§ñ Bot: ON",
      botBtnOff: "ü§ñ Bot: OFF",
      twoPlayerBtnOn: "üë• Two Players: ON",
      twoPlayerBtnOff: "üë• Two Players: OFF",
      exportBtn: "üì§ Export",
      importBtn: "üì• Import",
      questsBtn: "üéØ Quests",
      settingsBtn: "‚öôÔ∏è Settings",
      resetBtn: "üóëÔ∏è Reset Progress",
      onlineBtn: "üîó Online",
      onlineBtnConnected: "üîó Online (Connected)",
      bestRecord: "Best",
      points: "Points",
      time: "Time",
      level: "Level",
      gameOver: "üíÄ Game Over!",
      yourScore: "Your score",
      seconds: "s",
      retryBtn: "üîÅ Try Again",
      menuBtn: "üè† Menu",
      pause: "‚è∏Ô∏è Pause",
      gamePaused: "Game paused.",
      resumeBtn: "‚ñ∂ Resume",
      pauseMenuBtn: "üè† To Menu",
      pressEsc: "Press Esc or 'Resume' button",
      settingsTitle: "‚öôÔ∏è Settings",
      language: "üåê Language:",
      menuMusic: "üéµ Menu Music",
      gameMusic: "üéµ Game Music",
      vibration: "üì≥ Vibration",
      doneBtn: "‚úÖ Done",
      consolePlaceholder: "Enter command, e.g. /help",
      consoleSend: "Execute",
      close: "Close",
      player1: "Player 1",
      player2: "Player 2",
      player1Score: "Score 1",
      player2Score: "Score 2",
      coins: "Coins",
      revivalTitle: "üîÑ Revive?",
      revivalDescSingle: "You have 5 seconds to decide",
      revivalDescTwoPlayers: "Revive both players? You have 5 seconds",
      reviveBtn: "Revive",
      skipRevivalBtn: "Continue",
      revivalsLeftText: "Revivals left:",
      cost: "Cost:",
      questsTitle: "üéØ Quests",
      pwaWarning: "‚ö†Ô∏è Quests available only in installed version (PWA or APK)",
      backBtn: "‚Üê Back",
      fpsLimit: "üéÆ FPS Limit",
      rtcConnected: "üü¢ Connected to another player",
      rtcConnecting: "üü° Connecting...",
      rtcDisconnected: "üî¥ Not connected",
      rtcHost: "Host",
      rtcGuest: "Guest"
    }
  };
  
  // –°–∏—Å—Ç–µ–º–∞ –∫–≤–µ—Å—Ç—ñ–≤
  const quests = [
    {
      id: 'survive_30',
      name: { uk: '–í–∏–∂–∏—Ç–∏ 30 —Å–µ–∫—É–Ω–¥', en: 'Survive 30 seconds' },
      desc: { uk: '–ü—Ä–æ–¥–æ–≤–∂—É–π –≥—Ä—É –ø—Ä–æ—Ç—è–≥–æ–º 30 —Å–µ–∫—É–Ω–¥ –±–µ–∑ —Å–º–µ—Ä—Ç—ñ', en: 'Keep playing for 30 seconds without dying' },
      condition: { type: 'time', target: 30 },
      reward: 5,
      progress: 0
    },
    {
      id: 'collect_coins',
      name: { uk: '–ó—ñ–±—Ä–∞—Ç–∏ 10 –º–æ–Ω–µ—Ç', en: 'Collect 10 coins' },
      desc: { uk: '–ó–±–µ—Ä–∏ 10 –∑–æ–ª–æ—Ç–∏—Ö –º–æ–Ω–µ—Ç –ø—ñ–¥ —á–∞—Å –≥—Ä–∏', en: 'Collect 10 gold coins during the game' },
      condition: { type: 'coins', target: 10 },
      reward: 10,
      progress: 0
    },
    {
      id: 'kill_enemies',
      name: { uk: '–ó–Ω–∏—â–∏—Ç–∏ 20 –≤–æ—Ä–æ–≥—ñ–≤', en: 'Kill 20 enemies' },
      desc: { uk: '–ó–Ω–∏—â 20 —á–µ—Ä–≤–æ–Ω–∏—Ö –≤–æ—Ä–æ–≥—ñ–≤ (–∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é —â–∏—Ç–∞ –∞–±–æ –±–æ—Ç–∞)', en: 'Destroy 20 red enemies (using shield or bot)' },
      condition: { type: 'enemies', target: 20 },
      reward: 15,
      progress: 0
    },
    {
      id: 'use_powerups',
      name: { uk: '–í–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ 5 –ø–∞–≤–µ—Ä-–∞–ø—ñ–≤', en: 'Use 5 power-ups' },
      desc: { uk: '–ê–∫—Ç–∏–≤—É–π 5 —Ä—ñ–∑–Ω–∏—Ö –ø–∞–≤–µ—Ä-–∞–ø—ñ–≤ –ø—ñ–¥ —á–∞—Å –≥—Ä–∏', en: 'Activate 5 different power-ups during the game' },
      condition: { type: 'powerups', target: 5 },
      reward: 8,
      progress: 0
    }
  ];
  
  // –ó–º—ñ–Ω–Ω—ñ –¥–ª—è –µ—Ñ–µ–∫—Ç—ñ–≤ - –æ–∫—Ä–µ–º—ñ –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ –≥—Ä–∞–≤—Ü—è
  let activeEffects = {
    player1: {
      slowMotion: { active: false, endTime: 0 },
      shield: { active: false, endTime: 0 },
      speedBoost: { active: false, endTime: 0 }
    },
    player2: {
      slowMotion: { active: false, endTime: 0 },
      shield: { active: false, endTime: 0 },
      speedBoost: { active: false, endTime: 0 }
    }
  };
  
  // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–ª—è –∫–≤–µ—Å—Ç—ñ–≤
  let gameStats = {
    timeSurvived: 0,
    coinsCollected: 0,
    enemiesKilled: 0,
    powerupsUsed: 0
  };
  
  let joystick = {x:0, y:0, dx:0, dy:0, active:false};
  let player = {x:0,y:0,size:30,speed:4, alive: true};
  let isGameOverAnim = false;
  let isGameActive = false;
  let isGamePaused = false;
  let godMode = false;
  let helpTimeoutId = null;
  
    const SECURE_PASSWORD = String.fromCharCode(
    107,105,108,108,46,97,112,112
);

  /* ------------------ –°–ü–†–û–©–ï–ù–ê WEBRTC –°–ò–°–¢–ï–ú–ê ------------------ */
  
  // –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è –ø—Ä–æ—Å—Ç–æ–≥–æ 6-–∑–Ω–∞—á–Ω–æ–≥–æ –∫–æ–¥—É
  function generateRoomCode() {
    return Math.floor(100000 + Math.random() * 900000).toString();
  }
  
  function initSimpleWebRTC() {
    consoleLog('–ü—Ä–æ—Å—Ç–∞ –æ–Ω–ª–∞–π–Ω-—Å–∏—Å—Ç–µ–º–∞: –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–∞', 'info');
    
    // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –≥–ª–æ–±–∞–ª—å–Ω–∏–π —Å–µ—Ä–≤–µ—Ä
    signalingServer = window.globalSignalingServer;
    
    // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫ –¥–ª—è –≥–ª–æ–±–∞–ª—å–Ω–∏—Ö –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
    window.handleRTCFromGlobal = handleRTCMessage;
    
    // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –≥–ª–æ–±–∞–ª—å–Ω–∏–π –æ–±—Ä–æ–±–Ω–∏–∫
    window.peerHandler = window.peerHandlerGlobal;
    
    consoleLog('–ì–ª–æ–±–∞–ª—å–Ω–∞ —Å–∏–≥–Ω–∞–ª—å–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–∞', 'success');
  }
  
  function createSimpleHost() {
    isHost = true;
    roomCode = generateRoomCode();
    
    roomCodeEl.textContent = roomCode;
    mainPanel.style.display = 'none';
    hostPanel.style.display = 'block';
    
    setRTCStatus('waiting', '–û—á—ñ–∫—É–≤–∞–Ω–Ω—è –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –≥–æ—Å—Ç—è...');
    consoleLog(`–•–æ—Å—Ç: –ö—ñ–º–Ω–∞—Ç–∞ —Å—Ç–≤–æ—Ä–µ–Ω–∞. –ö–æ–¥: ${roomCode}`, 'success');
    
    // –†–µ—î—Å—Ç—Ä—É—î–º–æ –∫—ñ–º–Ω–∞—Ç—É –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–º—É —Å–µ—Ä–≤–µ—Ä—ñ
    signalingServer.createRoom(roomCode);
    
    // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ WebRTC –∑'—î–¥–Ω–∞–Ω–Ω—è
    setTimeout(() => {
      initWebRTCConnection();
    }, 500);
  }
  
  function joinSimpleRoom() {
    const code = joinCodeInput.value.trim();
    
    if (code.length !== 6 || !/^\d+$/.test(code)) {
      alert('–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å 6-–∑–Ω–∞—á–Ω–∏–π –∫–æ–¥');
      return;
    }
    
    isHost = false;
    roomCode = code;
    
    mainPanel.style.display = 'none';
    joinPanel.style.display = 'none';
    
    setRTCStatus('connecting', '–ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ –∫—ñ–º–Ω–∞—Ç–∏...');
    consoleLog(`–ì—ñ—Å—Ç—å: –°–ø—Ä–æ–±–∞ –ø—ñ–¥–∫–ª—é—á–∏—Ç–∏—Å—è –¥–æ –∫—ñ–º–Ω–∞—Ç–∏ ${code}`, 'info');
    
    // –°–ø—Ä–æ–±—É–≤–∞—Ç–∏ –ø—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—è –¥–æ –∫—ñ–º–Ω–∞—Ç–∏
    const result = signalingServer.joinRoom(code, 'peerHandler');
    
    if (result.error) {
      alert(`–ü–æ–º–∏–ª–∫–∞: ${result.error}`);
      showMainPanel();
      return;
    }
    
    // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ WebRTC –∑'—î–¥–Ω–∞–Ω–Ω—è
    setTimeout(() => {
      initWebRTCConnection();
    }, 500);
  }
  
  function initWebRTCConnection() {
    if (peerConnection) {
      peerConnection.close();
    }
    
    peerConnection = new RTCPeerConnection({
      iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' }
      ]
    });
    
    peerConnection.onicecandidate = (event) => {
      if (event.candidate) {
        // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ —á–µ—Ä–µ–∑ –Ω–∞—à—É —Å–ø—Ä–æ—â–µ–Ω—É —Å–∏—Å—Ç–µ–º—É
        sendSignalingMessage({
          type: 'ice-candidate',
          candidate: event.candidate
        });
      }
    };
    
    peerConnection.onconnectionstatechange = () => {
      const state = peerConnection.connectionState;
      consoleLog(`WebRTC: –°—Ç–∞–Ω –∑'—î–¥–Ω–∞–Ω–Ω—è - ${state}`, 'info');
      
      if (state === 'connected') {
        isConnected = true;
        setRTCStatus('connected', `${isHost ? '–•–æ—Å—Ç' : '–ì—ñ—Å—Ç—å'} - –ü—ñ–¥–∫–ª—é—á–µ–Ω–æ`);
        onlineBtn.textContent = translations[currentLanguage].onlineBtnConnected;
        onlineBtn.classList.add('active');
        sendTestBtn.disabled = false;
        disconnectBtn.disabled = false;
        consoleLog('WebRTC: –ü—ñ–¥–∫–ª—é—á–µ–Ω–æ –¥–æ —ñ–Ω—à–æ–≥–æ –≥—Ä–∞–≤—Ü—è!', 'success');
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–∞–ø—É—Å–∫–∞—î–º–æ –≥—Ä—É –¥–ª—è –æ–±–æ—Ö –≥—Ä–∞–≤—Ü—ñ–≤
        if (isHost) {
          setTimeout(() => {
            sendRTCMessage({ type: 'game_start' });
          }, 1000);
        }
      } else if (state === 'disconnected' || state === 'failed' || state === 'closed') {
        isConnected = false;
        setRTCStatus('disconnected', '–í—ñ–¥–∫–ª—é—á–µ–Ω–æ');
        onlineBtn.textContent = translations[currentLanguage].onlineBtn;
        onlineBtn.classList.remove('active');
        sendTestBtn.disabled = true;
        disconnectBtn.disabled = true;
        dataChannel = null;
        
        if (state === 'failed') {
          consoleLog('WebRTC: –ü–æ–º–∏–ª–∫–∞ –∑\'—î–¥–Ω–∞–Ω–Ω—è', 'error');
        }
      }
    };
    
    peerConnection.ondatachannel = (event) => {
      dataChannel = event.channel;
      setupDataChannel();
    };
    
    // –Ø–∫—â–æ –º–∏ —Ö–æ—Å—Ç - —Å—Ç–≤–æ—Ä—é—î–º–æ –∫–∞–Ω–∞–ª –¥–∞–Ω–∏—Ö
    if (isHost) {
      createDataChannel();
      createAndSendOffer();
    }
  }
  
  function createDataChannel() {
    if (!peerConnection) return;
    
    dataChannel = peerConnection.createDataChannel('game-data', {
      ordered: true,
      maxRetransmits: 3
    });
    
    setupDataChannel();
  }
  
  function setupDataChannel() {
    if (!dataChannel) return;
    
    dataChannel.onopen = () => {
      consoleLog('WebRTC: –ö–∞–Ω–∞–ª –¥–∞–Ω–∏—Ö –≤—ñ–¥–∫—Ä–∏—Ç–æ', 'success');
      setRTCStatus('connected', `${isHost ? '–•–æ—Å—Ç' : '–ì—ñ—Å—Ç—å'} - –ö–∞–Ω–∞–ª –≤—ñ–¥–∫—Ä–∏—Ç–æ`);
      
      // –ù–∞–¥—Å–∏–ª–∞—î–º–æ –ø–æ—á–∞—Ç–∫–æ–≤–∏–π —Å—Ç–∞–Ω
      setTimeout(() => {
        sendGameState(true);
      }, 500);
    };
    
    dataChannel.onclose = () => {
      consoleLog('WebRTC: –ö–∞–Ω–∞–ª –¥–∞–Ω–∏—Ö –∑–∞–∫—Ä–∏—Ç–æ', 'error');
      setRTCStatus('disconnected', '–ö–∞–Ω–∞–ª –∑–∞–∫—Ä–∏—Ç–æ');
    };
    
    dataChannel.onerror = (error) => {
      consoleLog(`WebRTC: –ü–æ–º–∏–ª–∫–∞ –∫–∞–Ω–∞–ª—É - ${error.message}`, 'error');
    };
    
    dataChannel.onmessage = (event) => {
      try {
        const message = JSON.parse(event.data);
        handleRTCMessage(message);
      } catch (error) {
        consoleLog(`WebRTC: –ü–æ–º–∏–ª–∫–∞ –æ–±—Ä–æ–±–∫–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è - ${error}`, 'error');
      }
    };
  }
  
  async function createAndSendOffer() {
    try {
      const offer = await peerConnection.createOffer();
      await peerConnection.setLocalDescription(offer);
      
      // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ offer —á–µ—Ä–µ–∑ –Ω–∞—à—É —Å–ø—Ä–æ—â–µ–Ω—É —Å–∏—Å—Ç–µ–º—É
      sendSignalingMessage({
        type: 'offer',
        sdp: peerConnection.localDescription
      });
      
    } catch (error) {
      consoleLog(`WebRTC: –ü–æ–º–∏–ª–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è offer - ${error}`, 'error');
    }
  }
  
  function sendSignalingMessage(message) {
    if (!signalingServer || !roomCode) return;
    
    signalingServer.sendMessage(roomCode, 'peerHandler', message);
  }
  
  // –û–±—Ä–æ–±–∫–∞ —Å–∏–≥–Ω–∞–ª—å–Ω–∏—Ö –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
  async function handleSignalingMessage(message) {
    if (!message || !message.type) return;
    
    try {
      switch(message.type) {
        case 'offer':
          if (isHost) return; // –•–æ—Å—Ç –Ω–µ –æ–±—Ä–æ–±–ª—è—î offer
          
          await peerConnection.setRemoteDescription(message.sdp);
          const answer = await peerConnection.createAnswer();
          await peerConnection.setLocalDescription(answer);
          
          // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ answer –Ω–∞–∑–∞–¥
          sendSignalingMessage({
            type: 'answer',
            sdp: peerConnection.localDescription
          });
          break;
          
        case 'answer':
          if (!isHost) return; // –ì—ñ—Å—Ç—å –Ω–µ –æ–±—Ä–æ–±–ª—è—î answer
          
          await peerConnection.setRemoteDescription(message.sdp);
          break;
          
        case 'ice-candidate':
          await peerConnection.addIceCandidate(message.candidate);
          break;
      }
    } catch (error) {
      consoleLog(`WebRTC: –ü–æ–º–∏–ª–∫–∞ –æ–±—Ä–æ–±–∫–∏ —Å–∏–≥–Ω–∞–ª—å–Ω–æ–≥–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è - ${error}`, 'error');
    }
  }
  
  function setRTCStatus(status, message) {
    const t = translations[currentLanguage];
    
    switch(status) {
      case 'connected':
        rtcStatus.textContent = `üü¢ ${t.rtcConnected}`;
        rtcStatus.style.color = '#0f0';
        rtcPeerInfo.textContent = message;
        break;
      case 'connecting':
        rtcStatus.textContent = `üü° ${t.rtcConnecting}`;
        rtcStatus.style.color = '#ffb86b';
        rtcPeerInfo.textContent = message;
        break;
      case 'waiting':
        rtcStatus.textContent = 'üü° –û—á—ñ–∫—É–≤–∞–Ω–Ω—è –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è...';
        rtcStatus.style.color = '#ffb86b';
        rtcPeerInfo.textContent = message;
        break;
      case 'disconnected':
        rtcStatus.textContent = `üî¥ ${t.rtcDisconnected}`;
        rtcStatus.style.color = '#ff6b6b';
        rtcPeerInfo.textContent = message || '–û–±–µ—Ä—ñ—Ç—å –¥—ñ—é';
        break;
    }
  }
  
  function sendRTCMessage(message) {
    if (!dataChannel || dataChannel.readyState !== 'open') {
      consoleLog('WebRTC: –ö–∞–Ω–∞–ª –¥–∞–Ω–∏—Ö –Ω–µ –≤—ñ–¥–∫—Ä–∏—Ç–∏–π –¥–ª—è –Ω–∞–¥—Å–∏–ª–∞–Ω–Ω—è', 'error');
      return false;
    }
    
    try {
      dataChannel.send(JSON.stringify(message));
      return true;
    } catch (error) {
      consoleLog(`WebRTC: –ü–æ–º–∏–ª–∫–∞ –Ω–∞–¥—Å–∏–ª–∞–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è - ${error}`, 'error');
      return false;
    }
  }
  
  // –í–ò–ü–†–ê–í–õ–ï–ù–ê –§–£–ù–ö–¶–Ü–Ø: –¥–æ–¥–∞–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—é —Å–º–µ—Ä—Ç—ñ
  function handleRTCMessage(message) {
    if (!message || !message.type) return;
    
    // –Ø–∫—â–æ —Ü–µ —Å–∏–≥–Ω–∞–ª—å–Ω–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
    if (message.type === 'offer' || message.type === 'answer' || message.type === 'ice-candidate') {
      handleSignalingMessage(message);
      return;
    }
    
    switch(message.type) {
      case 'ping':
        // –í—ñ–¥–ø–æ–≤—ñ–¥—å –Ω–∞ –ø—ñ–Ω–≥
        sendRTCMessage({ type: 'pong', timestamp: message.timestamp });
        break;
        
      case 'pong':
        // –û—Ç—Ä–∏–º–∞–Ω–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –Ω–∞ –ø—ñ–Ω–≥
        const latency = Date.now() - message.timestamp;
        consoleLog(`WebRTC: –ó–∞—Ç—Ä–∏–º–∫–∞ - ${latency}ms`, 'info');
        break;
        
      case 'game_state':
        // –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞–Ω—É –≥—Ä–∏ –≤—ñ–¥ —ñ–Ω—à–æ–≥–æ –≥—Ä–∞–≤—Ü—è
        if (message.player) {
          peerState.player = message.player;
          
          // –û–Ω–æ–≤–ª—é—î–º–æ –≥—Ä–∞–≤—Ü—è 2 –≤ —Ä–µ–∂–∏–º—ñ –æ–Ω–ª–∞–π–Ω
          if (!twoPlayerMode) {
            twoPlayerMode = true;
            updateTwoPlayerUI();
          }
          
          player2.x = message.player.x;
          player2.y = message.player.y;
          player2.size = message.player.size;
          player2.alive = message.player.alive; // –°–ò–ù–•–†–û–ù–Ü–ó–ê–¶–Ü–Ø –°–ú–ï–†–¢–Ü
          score2 = message.player.score || 0;
          
          // –û–Ω–æ–≤–ª—é—î–º–æ –ª—ñ—á–∏–ª—å–Ω–∏–∫–∏
          updateCounters();
        }
        
        if (message.gameState) {
          peerState.gameActive = message.gameState.active;
          peerState.timeSec = message.gameState.timeSec;
          
          // –í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ: —É–Ω–∏–∫–Ω–µ–Ω–Ω—è —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ—ó —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó –ø–∞—É–∑–∏
          if (message.gameState.paused !== isGamePaused && isGameActive) {
            // –¢—ñ–ª—å–∫–∏ —è–∫—â–æ –ø–∞—É–∑–∞ –∑–º—ñ–Ω–∏–ª–∞—Å—è, –∞ –≥—Ä–∞ –∞–∫—Ç–∏–≤–Ω–∞
            if (message.gameState.paused && !isGamePaused) {
              togglePauseWithoutSync(); // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —Ñ—É–Ω–∫—Ü—ñ—é –±–µ–∑ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó –Ω–∞–∑–∞–¥
            } else if (!message.gameState.paused && isGamePaused) {
              togglePauseWithoutSync();
            }
          }
        }
        break;
        
      case 'game_start':
        // –ó–∞–ø—É—Å–∫ –≥—Ä–∏ –≤—ñ–¥ —ñ–Ω—à–æ–≥–æ –≥—Ä–∞–≤—Ü—è
        if (!isGameActive && menu.style.display === 'none') {
          startGame();
          consoleLog('–Ü–Ω—à–∏–π –≥—Ä–∞–≤–µ—Ü—å –∑–∞–ø—É—Å—Ç–∏–≤ –≥—Ä—É!', 'success');
        }
        break;
        
      case 'game_pause':
        // –ü–∞—É–∑–∞ –≤—ñ–¥ —ñ–Ω—à–æ–≥–æ –≥—Ä–∞–≤—Ü—è - —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ –≥—Ä–∞ –∞–∫—Ç–∏–≤–Ω–∞ —ñ –Ω–µ –≤–∂–µ –Ω–∞ –ø–∞—É–∑—ñ
        if (!isGamePaused && isGameActive) {
          togglePauseWithoutSync();
        }
        break;
        
      case 'game_resume':
        // –ü—Ä–æ–¥–æ–≤–∂–µ–Ω–Ω—è –≥—Ä–∏ –≤—ñ–¥ —ñ–Ω—à–æ–≥–æ –≥—Ä–∞–≤—Ü—è - —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ –≥—Ä–∞ –Ω–∞ –ø–∞—É–∑—ñ
        if (isGamePaused && isGameActive) {
          togglePauseWithoutSync();
        }
        break;
        
      case 'game_over':
        // –ì—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —ñ–Ω—à–∏–º –≥—Ä–∞–≤—Ü–µ–º
        if (isGameActive) {
          endGame();
        }
        break;
        
      case 'player_death':
        // –°–º–µ—Ä—Ç—å —ñ–Ω—à–æ–≥–æ –≥—Ä–∞–≤—Ü—è
        consoleLog('–Ü–Ω—à–∏–π –≥—Ä–∞–≤–µ—Ü—å –ø–æ–º–µ—Ä!', 'error');
        // –í —Ä–µ–∂–∏–º—ñ –æ–Ω–ª–∞–π–Ω - –≥—Ä–∞–≤–µ—Ü—å 2 –ø–æ–º–∏—Ä–∞—î –ø–æ-—Å–ø—Ä–∞–≤–∂–Ω—å–æ–º—É
        if (twoPlayerMode && player2.alive) {
          playerDeath(player2);
        }
        break;
        
      case 'player_revive':
        // –í—ñ–¥—Ä–æ–¥–∂–µ–Ω–Ω—è —ñ–Ω—à–æ–≥–æ –≥—Ä–∞–≤—Ü—è
        consoleLog('–Ü–Ω—à–∏–π –≥—Ä–∞–≤–µ—Ü—å –≤—ñ–¥—Ä–æ–¥–∏–≤—Å—è!', 'success');
        if (twoPlayerMode && !player2.alive) {
          player2.alive = true;
          player2.x = width / 2 - player2.size / 2;
          player2.y = height / 2 - player2.size / 2;
        }
        break;
        
      case 'chat_message':
        // –ß–∞—Ç –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
        if (message.text) {
          consoleLog(`[–ß–∞—Ç] ${message.sender || '–Ü–Ω—à–∏–π –≥—Ä–∞–≤–µ—Ü—å'}: ${message.text}`, 'info');
        }
        break;
    }
  }
  
  // –ù–û–í–ê –§–£–ù–ö–¶–Ü–Ø: –ø–∞—É–∑–∞ –±–µ–∑ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—ó –Ω–∞–∑–∞–¥
  function togglePauseWithoutSync() {
    if(!isGameActive || isGameOverAnim || waitingForRevival) return;

    isGamePaused = !isGamePaused;
    pauseModal.style.display = isGamePaused ? 'flex' : 'none';

    if(isGamePaused){
      cancelAnimationFrame(animationId);
      clearInterval(timeTimer);
      clearInterval(spawnTimer);
      clearInterval(bonusTimer);
      clearInterval(powerupTimer);
      clearInterval(coinTimer);
      stopGameMusic();
    } else {
      if (!twoPlayerMode) {
        timeTimer=setInterval(()=>{
          timeSec++; 
          updateCounters();
          updateDifficulty();
        },1000);
      }
      spawnTimer=setInterval(()=>spawnEnemy(),enemySpawnRate);
      bonusTimer=setInterval(()=>spawnBonus(),5000);
      powerupTimer=setInterval(()=>spawnRandomPowerup(),15000);
      coinTimer=setInterval(()=>spawnCoin(),10000);
      animationId=requestAnimationFrame(loop);
      playGameMusic();
    }
  }
  
  function sendGameState(force = false) {
    if (!isConnected || !dataChannel || dataChannel.readyState !== 'open') return;
    
    const now = Date.now();
    if (!force && now - lastSentState < 100) return; // –ù–µ —á–∞—Å—Ç—ñ—à–µ –Ω—ñ–∂ 10 —Ä–∞–∑—ñ–≤ –Ω–∞ —Å–µ–∫—É–Ω–¥—É
    
    lastSentState = now;
    
    const stateMessage = {
      type: 'game_state',
      timestamp: now,
      player: {
        x: Math.round(player.x),
        y: Math.round(player.y),
        size: player.size,
        speed: player.speed,
        alive: player.alive, // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ —Å—Ç–∞–Ω –∂–∏–≤—É—á–æ—Å—Ç—ñ
        score: score,
        effects: activeEffects.player1
      },
      gameState: {
        active: isGameActive,
        paused: isGamePaused,
        timeSec: timeSec,
        level: level,
        enemies: enemies.length,
        score: score
      }
    };
    
    sendRTCMessage(stateMessage);
  }
  
  function sendGameCommand(command, data = {}) {
    if (!isConnected) return;
    
    const message = {
      type: `game_${command}`,
      timestamp: Date.now(),
      ...data
    };
    
    sendRTCMessage(message);
  }
  
  function disconnectWebRTC() {
    if (dataChannel) {
      dataChannel.close();
      dataChannel = null;
    }
    
    if (peerConnection) {
      peerConnection.close();
      peerConnection = null;
    }
    
    if (signalingServer && roomCode) {
      signalingServer.cleanupRoom(roomCode);
    }
    
    isConnected = false;
    isHost = false;
    roomCode = '';
    setRTCStatus('disconnected', '–í—ñ–¥–∫–ª—é—á–µ–Ω–æ');
    onlineBtn.textContent = translations[currentLanguage].onlineBtn;
    onlineBtn.classList.remove('active');
    sendTestBtn.disabled = true;
    disconnectBtn.disabled = true;
    
    // –°–∫–∏–¥–∞—î–º–æ —Ä–µ–∂–∏–º –¥–≤–æ—Ö –≥—Ä–∞–≤—Ü—ñ–≤ —è–∫—â–æ –±—É–≤ –æ–Ω–ª–∞–π–Ω
    if (twoPlayerMode) {
      twoPlayerMode = false;
      updateTwoPlayerUI();
    }
    
    // –ü–æ–∫–∞–∑—É—î–º–æ –≥–æ–ª–æ–≤–Ω—É –ø–∞–Ω–µ–ª—å
    showMainPanel();
    
    consoleLog('WebRTC: –í—ñ–¥–∫–ª—é—á–µ–Ω–æ', 'info');
  }
  
  function testConnection() {
    if (!isConnected) {
      alert('–°–ø–æ—á–∞—Ç–∫—É –ø—ñ–¥–∫–ª—é—á—ñ—Ç—å—Å—è –¥–æ —ñ–Ω—à–æ–≥–æ –≥—Ä–∞–≤—Ü—è');
      return;
    }
    
    const pingMessage = {
      type: 'ping',
      timestamp: Date.now()
    };
    
    if (sendRTCMessage(pingMessage)) {
      consoleLog('WebRTC: Ping –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ', 'info');
    }
  }
  
  function copyRoomCodeToClipboard() {
    if (!roomCode) return;
    
    navigator.clipboard.writeText(roomCode)
      .then(() => {
        consoleLog('–ö–æ–¥ –∫—ñ–º–Ω–∞—Ç–∏ —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º—ñ–Ω—É', 'success');
        alert(`–ö–æ–¥ ${roomCode} —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ! –î–∞–π—Ç–µ –π–æ–≥–æ —ñ–Ω—à–æ–º—É –≥—Ä–∞–≤—Ü—é.`);
      })
      .catch(err => {
        consoleLog('–ü–æ–º–∏–ª–∫–∞ –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—è –≤ –±—É—Ñ–µ—Ä –æ–±–º—ñ–Ω—É', 'error');
      });
  }
  
  function showMainPanel() {
    mainPanel.style.display = 'block';
    hostPanel.style.display = 'none';
    joinPanel.style.display = 'none';
  }
  
  function showJoinPanel() {
    mainPanel.style.display = 'none';
    hostPanel.style.display = 'none';
    joinPanel.style.display = 'block';
  }

  /* ------------------ –§–£–ù–ö–¶–Ü–á –®–ò–§–†–£–í–ê–ù–ù–Ø/–î–ï–®–ò–§–†–£–í–ê–ù–ù–Ø ------------------ */
  function encryptData(data) {
    const jsonStr = JSON.stringify(data);
    let encrypted = '';
    
    // –ü—Ä–æ—Å—Ç–µ XOR —à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è –∑ –∫–ª—é—á–µ–º
    for (let i = 0; i < jsonStr.length; i++) {
      const keyChar = ENCRYPTION_KEY.charCodeAt(i % ENCRYPTION_KEY.length);
      const dataChar = jsonStr.charCodeAt(i);
      const encryptedChar = dataChar ^ keyChar;
      
      // –ö–æ–Ω–≤–µ—Ä—Ç—É—î–º–æ —É hex –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è
      encrypted += ('00' + encryptedChar.toString(16)).slice(-2);
    }
    
    // –î–æ–¥–∞—î–º–æ —Å–∏–≥–Ω–∞—Ç—É—Ä—É –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏
    return 'BR' + btoa(encrypted) + 'END';
  }

  function decryptData(encryptedStr) {
    try {
      // –í–∏–¥–∞–ª—è—î–º–æ —Å–∏–≥–Ω–∞—Ç—É—Ä—É
      if (!encryptedStr.startsWith('BR') || !encryptedStr.endsWith('END')) {
        throw new Error('–ù–µ–≤—ñ—Ä–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª—É');
      }
      
      const base64Data = encryptedStr.slice(2, -3);
      const hexData = atob(base64Data);
      
      let decrypted = '';
      for (let i = 0; i < hexData.length; i += 2) {
        const hexByte = hexData.substr(i, 2);
        const encryptedChar = parseInt(hexByte, 16);
        const keyChar = ENCRYPTION_KEY.charCodeAt((i/2) % ENCRYPTION_KEY.length);
        const decryptedChar = encryptedChar ^ keyChar;
        decrypted += String.fromCharCode(decryptedChar);
      }
      
      return JSON.parse(decrypted);
    } catch (error) {
      consoleLog('–ü–æ–º–∏–ª–∫–∞ –¥–µ—à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è: ' + error.message, 'error');
      return null;
    }
  }

  /* ------------------ –§—É–Ω–∫—Ü—ñ—ó –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ª—ñ—á–∏–ª—å–Ω–∏–∫—ñ–≤ ------------------ */
  function updateCounters() {
    if (timeEl) timeEl.textContent = timeSec;
    if (bestEl) bestEl.textContent = best;
    if (scoreEl) scoreEl.textContent = score;
    if (levelEl) levelEl.textContent = level;
    if (bestMenuEl) bestMenuEl.textContent = best;
    if (scoreMenuEl) scoreMenuEl.textContent = bestScore;
    
    // –û–Ω–æ–≤–ª—é—î–º–æ –æ—á–∫–∏ –¥—Ä—É–≥–æ–≥–æ –≥—Ä–∞–≤—Ü—è
    if (twoPlayerMode) {
      const score2El = document.getElementById('score2');
      if (score2El) score2El.querySelector('span').textContent = score2;
    }
    
    // –û–Ω–æ–≤–ª—é—î–º–æ –º–æ–Ω–µ—Ç–∏
    updateCoinsDisplay();
  }

  function updateCoinsDisplay() {
    if (coinsDisplay) {
      coinsDisplay.textContent = coinsAmount;
    }
  }

  function updateGameOverCounters() {
    if (scoreOut) scoreOut.textContent = timeSec;
    if (finalScore) finalScore.textContent = score;
    if (bestOut) bestOut.textContent = best;
  }

  /* ------------------ –§—É–Ω–∫—Ü—ñ—ó –ø–µ—Ä–µ–∫–ª–∞–¥—É ------------------ */
  function updateLanguage() {
    const t = translations[currentLanguage];
    
    // –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Ç–µ–∫—Å—Ç—É –≤ DOM
    document.title = t.title;
    document.querySelector('#menu h1').textContent = t.gameTitle;
    document.querySelector('#menu p').textContent = t.gameSubtitle;
    startBtn.textContent = t.startBtn;
    howBtn.textContent = t.howBtn;
    settingsBtn.textContent = t.settingsBtn;
    resetBtn.textContent = t.resetBtn;
    exportBtn.textContent = t.exportBtn;
    importBtn.textContent = t.importBtn;
    onlineBtn.textContent = isConnected ? t.onlineBtnConnected : t.onlineBtn;
    
    // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–Ω–æ–ø–∫–∏ –¥–≤–æ—Ö –≥—Ä–∞–≤—Ü—ñ–≤
    if (twoPlayerBtn) {
      updateTwoPlayerButton();
    }
    
    // –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Ç–µ–∫—Å—Ç—É –≤ UI –≥—Ä–∏ –±–µ–∑ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—É –ª—ñ—á–∏–ª—å–Ω–∏–∫—ñ–≤
    const controls = document.querySelector('#ui .controls');
    if (controls) {
      const timeSpan = controls.querySelector('span:nth-child(1)');
      const bestSpan = controls.querySelector('span:nth-child(2)');
      const scoreSpan = controls.querySelector('span:nth-child(3)');
      
      if (timeSpan) timeSpan.innerHTML = `${t.time}: <span id="time">${timeSec}</span>`;
      if (bestSpan) bestSpan.innerHTML = `${t.bestRecord}: <span id="best">${best}</span>`;
      if (scoreSpan) scoreSpan.innerHTML = `${t.points}: <span id="score">${score}</span>`;
      
      // –û–Ω–æ–≤–ª—é—î–º–æ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –µ–ª–µ–º–µ–Ω—Ç–∏
      timeEl = document.getElementById('time');
      bestEl = document.getElementById('best');
      scoreEl = document.getElementById('score');
    }
    
    // –û–Ω–æ–≤–ª–µ–Ω–Ω—è —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ —Ä—ñ–≤–Ω—è
    const levelIndicator = document.querySelector('.level-indicator');
    if (levelIndicator) {
      levelIndicator.innerHTML = `${t.level}: <span id="level">${level}</span>`;
      levelEl = document.getElementById('level');
    }
    
    // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –º–µ–Ω—é
    const menuStats = document.querySelector('#menu .small');
    if (menuStats) {
      menuStats.innerHTML = `${t.bestRecord}: <strong id="bestMenu">${best}</strong> | ${t.points}: <strong id="scoreMenu">${bestScore}</strong>`;
      bestMenuEl = document.getElementById('bestMenu');
      scoreMenuEl = document.getElementById('scoreMenu');
    }
    
    // –û–Ω–æ–≤–ª–µ–Ω–Ω—è game over –µ–∫—Ä–∞–Ω—É
    document.querySelector('#gameOver h1').textContent = t.gameOver;
    const gameOverScore = document.querySelector('#gameOver p:nth-child(2)');
    const gameOverPoints = document.querySelector('#gameOver p:nth-child(3)');
    const gameOverBest = document.querySelector('#gameOver .small');
    
    if (gameOverScore) gameOverScore.innerHTML = `${t.yourScore}: <strong id="scoreOut">${timeSec}</strong> ${t.seconds}`;
    if (gameOverPoints) gameOverPoints.innerHTML = `${t.points}: <strong id="finalScore">${score}</strong>`;
    if (gameOverBest) gameOverBest.innerHTML = `${t.bestRecord}: <strong id="bestOut">${best}</strong> ${t.seconds}`;
    
    scoreOut = document.getElementById('scoreOut');
    finalScore = document.getElementById('finalScore');
    bestOut = document.getElementById('bestOut');
    
    retryBtn.textContent = t.retryBtn;
    menuBtn.textContent = t.menuBtn;
    
    document.querySelector('.pause-content h2').textContent = t.pause;
    document.querySelector('.pause-content p').textContent = t.gamePaused;
    resumeBtn.textContent = t.resumeBtn;
    pauseMenuBtn.textContent = t.pauseMenuBtn;
    document.querySelector('.pause-content .small').textContent = t.pressEsc;
    
    // –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Ç–µ–∫—Å—Ç—É –≤ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è—Ö
    document.querySelector('.settings-content h2').textContent = t.settingsTitle;
    document.querySelector('.settings-item:nth-child(1) label').textContent = t.language;
    document.querySelector('.settings-item:nth-child(2) label').textContent = t.fpsLimit;
    document.querySelector('.settings-item:nth-child(3) label').textContent = t.menuMusic;
    document.querySelector('.settings-item:nth-child(4) label').textContent = t.gameMusic;
    document.querySelector('.settings-item:nth-child(5) label').textContent = t.vibration;
    closeSettingsBtn.textContent = t.doneBtn;
    closeQuestsModal.textContent = t.backBtn;
    
    // –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Ç–µ–∫—Å—Ç—É –≤—ñ–¥—Ä–æ–¥–∂–µ–Ω–Ω—è
    document.querySelector('#revivalModal h2').textContent = t.revivalTitle;
    // –û–ø–∏—Å –±—É–¥–µ –æ–Ω–æ–≤–ª–µ–Ω–æ –¥–∏–Ω–∞–º—ñ—á–Ω–æ –≤ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ –≤—ñ–¥ –∫—ñ–ª—å–∫–æ—Å—Ç—ñ –≥—Ä–∞–≤—Ü—ñ–≤
    reviveBtn.textContent = t.reviveBtn;
    skipRevivalBtn.textContent = t.skipRevivalBtn;
    document.querySelector('.revival-remaining').innerHTML = `${t.revivalsLeftText} <span id="revivalsLeft">${revivalsRemaining}</span>`;
    document.querySelector('.revival-cost').innerHTML = `${t.cost} <span id="revivalCost">${revivalPrice}</span> ü™ô`;
    
    // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–≤–µ—Å—Ç—ñ–≤
    document.querySelector('#questsModal h2').textContent = t.questsTitle;
    pwaWarning.querySelector('p').textContent = t.pwaWarning;
    
    // –û–Ω–æ–≤–ª–µ–Ω–Ω—è WebRTC –≤—ñ–∫–Ω–∞
    document.querySelector('#rtcModal .rtc-header strong').textContent = 'üîó –û–Ω–ª–∞–π–Ω –≥—Ä–∞ (–ü—Ä–æ—Å—Ç–∞ –≤–µ—Ä—Å—ñ—è)';
    createRoomBtn.textContent = '‚ú® –°—Ç–≤–æ—Ä–∏—Ç–∏ –∫—ñ–º–Ω–∞—Ç—É';
    joinRoomMainBtn.textContent = 'üîå –ü—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—å –¥–æ –∫—ñ–º–Ω–∞—Ç–∏';
    copyRoomCodeBtn.textContent = 'üìã –ö–æ–ø—ñ—é–≤–∞—Ç–∏ –∫–æ–¥';
    startGameAsHostBtn.textContent = '‚ñ∂ –ü–æ—á–∞—Ç–∏ –≥—Ä—É';
    joinRoomBtn.textContent = 'üîå –ü—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—å';
    sendTestBtn.textContent = '‚ñ∂ –¢–µ—Å—Ç –∑\'—î–¥–Ω–∞–Ω–Ω—è';
    disconnectBtn.textContent = 'üîå –í—ñ–¥–∫–ª—é—á–∏—Ç–∏—Å—å';
    
    consoleInput.placeholder = t.consolePlaceholder;
    consoleSend.textContent = t.consoleSend;
    closeConsoleBtn.textContent = t.close;
    closeCodeModal.textContent = t.close;
    closeHelpModal.textContent = t.close;

    // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–Ω–æ–ø–∫–∏ –±–æ—Ç–∞
    updateBotButton();
    
    // –û–Ω–æ–≤–ª–µ–Ω–Ω—è UI –¥–ª—è –¥–≤–æ—Ö –≥—Ä–∞–≤—Ü—ñ–≤
    if (twoPlayerMode) {
      updateTwoPlayerUI();
    }
    
    // –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞—Ç—É—Å—É WebRTC
    if (isConnected) {
      setRTCStatus('connected', `${isHost ? t.rtcHost : t.rtcGuest} - –ü—ñ–¥–∫–ª—é—á–µ–Ω–æ`);
    } else {
      setRTCStatus('disconnected', t.rtcDisconnected);
    }
  }

  /* ------------------ –°–ò–°–¢–ï–ú–ê –Ü–ú–ü–û–†–¢–£/–ï–ö–°–ü–û–†–¢–£ –†–ï–ö–û–†–î–Ü–í ------------------ */
  function exportRecords() {
    const data = {
      bestTime: best,
      bestScore: bestScore,
      coins: coinsAmount,
      quests: quests.map(q => ({id: q.id, progress: q.progress})),
      timestamp: Date.now(),
      version: '1.8.1'
    };
    
    // –®–∏—Ñ—Ä—É—î–º–æ –¥–∞–Ω—ñ
    const encryptedData = encryptData(data);
    
    const blob = new Blob([encryptedData], { type: 'application/octet-stream' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `block-runner-save-${new Date().toISOString().slice(0,10)}.brs`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    consoleLog('–†–µ–∫–æ—Ä–¥–∏ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω—ñ —Ç–∞ –µ–∫—Å–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ —É —Ñ–∞–π–ª', 'success');
  }

  function importRecords() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.brs';
    
    input.onchange = (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          const encryptedStr = event.target.result;
          const data = decryptData(encryptedStr);
          
          if (!data) {
            alert('–ù–µ–≤—ñ—Ä–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª—É –∞–±–æ —Ñ–∞–π–ª –ø–æ—à–∫–æ–¥–∂–µ–Ω–∏–π');
            return;
          }
          
          // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤–µ—Ä—Å—ñ—ó
          if (!data.version) {
            if (confirm('–¶–µ–π —Ñ–∞–π–ª –º–æ–∂–µ –±—É—Ç–∏ –∑—ñ —Å—Ç–∞—Ä–æ—ó –≤–µ—Ä—Å—ñ—ó. –ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏?')) {
              importData(data);
            }
          } else {
            importData(data);
          }
        } catch (err) {
          alert('–ü–æ–º–∏–ª–∫–∞ —á–∏—Ç–∞–Ω–Ω—è —Ñ–∞–π–ª—É. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —Ñ–æ—Ä–º–∞—Ç.');
          consoleLog('–ü–æ–º–∏–ª–∫–∞ —ñ–º–ø–æ—Ä—Ç—É: ' + err.message, 'error');
        }
      };
      reader.readAsText(file);
    };
    
    input.click();
  }

  function importData(data) {
    if (confirm('–ü–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç–∏ –ø–æ—Ç–æ—á–Ω—ñ —Ä–µ–∫–æ—Ä–¥–∏ –¥–∞–Ω–∏–º–∏ –∑ —Ñ–∞–π–ª—É?')) {
      if (data.bestTime !== undefined) {
        best = data.bestTime;
        localStorage.setItem('bestTime', best);
      }
      if (data.bestScore !== undefined) {
        bestScore = data.bestScore;
        localStorage.setItem('bestScore', bestScore);
      }
      if (data.coins !== undefined) {
        coinsAmount = data.coins;
        localStorage.setItem('coins', coinsAmount);
        updateCoinsDisplay();
      }
      if (data.quests !== undefined && isPWA) {
        data.quests.forEach(savedQuest => {
          const quest = quests.find(q => q.id === savedQuest.id);
          if (quest) {
            quest.progress = savedQuest.progress;
          }
        });
        saveQuests();
      }
      
      updateCounters();
      consoleLog('–†–µ–∫–æ—Ä–¥–∏ —É—Å–ø—ñ—à–Ω–æ —ñ–º–ø–æ—Ä—Ç–æ–≤–∞–Ω–æ —Ç–∞ —Ä–æ–∑—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ', 'success');
    }
  }

  /* ------------------ –°–ò–°–¢–ï–ú–ê –ö–í–ï–°–¢–Ü–í ------------------ */
  function checkPWA() {
    isPWA = window.matchMedia('(display-mode: standalone)').matches || 
            window.navigator.standalone || 
            document.referrer.includes('android-app://');
    
    // –û–Ω–æ–≤–ª—é—î–º–æ –≤–∏–¥–∏–º—ñ—Å—Ç—å –∫–Ω–æ–ø–∫–∏ –∫–≤–µ—Å—Ç—ñ–≤
    if (questsBtn) {
      if (isPWA) {
        questsBtn.style.display = 'block';
        questsBtn.textContent = translations[currentLanguage].questsBtn;
      } else {
        questsBtn.style.display = 'none';
      }
    }
    
    if (!isPWA) {
      pwaWarning.style.display = 'block';
    } else {
      pwaWarning.style.display = 'none';
    }
    return isPWA;
  }

  function loadQuests() {
    if (!isPWA) return;
    
    const saved = localStorage.getItem('quests');
    if (saved) {
      try {
        const savedQuests = JSON.parse(saved);
        quests.forEach(q => {
          const savedQuest = savedQuests.find(sq => sq.id === q.id);
          if (savedQuest) {
            q.progress = savedQuest.progress;
          }
        });
      } catch (e) {
        consoleLog('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–≤–µ—Å—Ç—ñ–≤', 'error');
      }
    }
  }

  function saveQuests() {
    if (!isPWA) return;
    localStorage.setItem('quests', JSON.stringify(quests));
  }

  function updateQuestProgress(questId, amount = 1) {
    if (!isPWA) return;
    
    const quest = quests.find(q => q.id === questId);
    if (!quest || quest.progress >= quest.condition.target) return;
    
    quest.progress = Math.min(quest.progress + amount, quest.condition.target);
    
    if (quest.progress >= quest.condition.target) {
      coinsAmount += quest.reward;
      localStorage.setItem('coins', coinsAmount);
      updateCoinsDisplay();
      consoleLog(`üéâ –ö–≤–µ—Å—Ç "${quest.name[currentLanguage]}" –∑–∞–≤–µ—Ä—à–µ–Ω–æ! –ù–∞–≥–æ—Ä–æ–¥–∞: ${quest.reward} ü™ô`, 'success');
    }
    
    saveQuests();
    updateQuestsDisplay();
  }

  function updateQuestsDisplay() {
    questsList.innerHTML = '';
    
    quests.forEach(quest => {
      const questEl = document.createElement('div');
      questEl.className = 'quest-item';
      
      const progressPercent = (quest.progress / quest.condition.target) * 100;
      const isCompleted = quest.progress >= quest.condition.target;
      
      questEl.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <strong style="color: ${isCompleted ? '#0f0' : '#fff'}">${quest.name[currentLanguage]}</strong>
          <span style="font-size: 12px;">${quest.progress}/${quest.condition.target}</span>
        </div>
        <p style="margin: 8px 0; font-size: 14px;">${quest.desc[currentLanguage]}</p>
        <div class="quest-progress">
          <div class="quest-progress-bar" style="width: ${progressPercent}%"></div>
        </div>
        <div class="quest-reward">
          –ù–∞–≥–æ—Ä–æ–¥–∞: ${quest.reward} ü™ô ${isCompleted ? '‚úÖ' : ''}
        </div>
      `;
      
      questsList.appendChild(questEl);
    });
  }

  function openQuests() {
    if (!isPWA) {
      alert(translations[currentLanguage].pwaWarning);
      return;
    }
    
    updateQuestsDisplay();
    questsModal.style.display = 'flex';
  }

  /* ------------------ –°–ò–°–¢–ï–ú–ê –ú–û–ù–ï–¢ ------------------ */
  function addCoin(amount = 1) {
    coinsAmount += amount;
    localStorage.setItem('coins', coinsAmount);
    updateCoinsDisplay();
    
    // –û–Ω–æ–≤–ª—é—î–º–æ –∫–≤–µ—Å—Ç –∑–±–æ—Ä—É –º–æ–Ω–µ—Ç
    if (isPWA) {
      updateQuestProgress('collect_coins', amount);
    }
  }

  function spawnCoin() {
    if (coins.length < 2) { // –ú–∞–∫—Å–∏–º—É–º 2 –º–æ–Ω–µ—Ç–∏ –æ–¥–Ω–æ—á–∞—Å–Ω–æ
      coins.push({
        x: Math.random() * (width - 20),
        y: Math.random() * (height - 20),
        size: 12,
        life: 300, // 5 —Å–µ–∫—É–Ω–¥ –ø—Ä–∏ 60 FPS
        collected: false
      });
    }
  }

  /* ------------------ –°–ò–°–¢–ï–ú–ê –í–Ü–î–†–û–î–ñ–ï–ù–ù–Ø (–í–ò–ü–†–ê–í–õ–ï–ù–ê) ------------------ */
  function showRevivalModal() {
    if (revivalsRemaining <= 0) {
      endGame();
      return;
    }
    
    // –ó—É–ø–∏–Ω—è—î–º–æ –≤—Å—é –≥—Ä—É –ø—ñ–¥ —á–∞—Å –≤—ñ–¥—Ä–æ–¥–∂–µ–Ω–Ω—è
    isGameActive = false;
    cancelAnimationFrame(animationId);
    clearInterval(timeTimer);
    clearInterval(spawnTimer);
    clearInterval(bonusTimer);
    clearInterval(powerupTimer);
    clearInterval(coinTimer);
    
    // –í–∏–∑–Ω–∞—á–∞—î–º–æ –≤–∞—Ä—Ç—ñ—Å—Ç—å
    revivalPrice = (3 - revivalsRemaining + 1) * deadPlayers.length; // –ú–Ω–æ–∂–∏–º–æ –Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –≥—Ä–∞–≤—Ü—ñ–≤
    revivalSeconds = 5;
    revivalTimer.textContent = revivalSeconds;
    revivalCost.textContent = revivalPrice;
    revivalsLeft.textContent = revivalsRemaining;
    
    // –û–Ω–æ–≤–ª—é—î–º–æ –æ–ø–∏—Å –≤ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ –≤—ñ–¥ –∫—ñ–ª—å–∫–æ—Å—Ç—ñ –≥—Ä–∞–≤—Ü—ñ–≤
    const t = translations[currentLanguage];
    if (deadPlayers.length === 2) {
      revivalDescription.textContent = t.revivalDescTwoPlayers;
    } else {
      revivalDescription.textContent = t.revivalDescSingle;
    }
    
    // –ë–ª–æ–∫—É–≤–∞–Ω–Ω—è –∫–Ω–æ–ø–∫–∏ –≤—ñ–¥—Ä–æ–¥–∂–µ–Ω–Ω—è, —è–∫—â–æ –Ω–µ –≤–∏—Å—Ç–∞—á–∞—î –º–æ–Ω–µ—Ç
    reviveBtn.disabled = coinsAmount < revivalPrice;
    
    revivalModal.style.display = 'flex';
    waitingForRevival = true;
    
    revivalTimerId = setInterval(() => {
      revivalSeconds--;
      revivalTimer.textContent = revivalSeconds;
      
      if (revivalSeconds <= 0) {
        cancelRevival();
      }
    }, 1000);
    
    // –ü–æ–≤—ñ–¥–æ–º–ª—è—î–º–æ —ñ–Ω—à–æ–≥–æ –≥—Ä–∞–≤—Ü—è –ø—Ä–æ —Å–º–µ—Ä—Ç—å
    if (isConnected) {
      sendGameCommand('player_death');
    }
  }

  function performRevival() {
    if (coinsAmount < revivalPrice) {
      consoleLog('–ù–µ –≤–∏—Å—Ç–∞—á–∞—î –º–æ–Ω–µ—Ç –¥–ª—è –≤—ñ–¥—Ä–æ–¥–∂–µ–Ω–Ω—è', 'error');
      return;
    }
    
    clearInterval(revivalTimerId);
    waitingForRevival = false;
    
    // –°–ø–∏—Å–∞—Ç–∏ –º–æ–Ω–µ—Ç–∏
    coinsAmount -= revivalPrice;
    localStorage.setItem('coins', coinsAmount);
    updateCoinsDisplay();
    
    // –í—ñ–¥—Ä–æ–¥–∏—Ç–∏ –≤—Å—ñ—Ö –º–µ—Ä—Ç–≤–∏—Ö –≥—Ä–∞–≤—Ü—ñ–≤
    deadPlayers.forEach(deadPlayer => {
      deadPlayer.alive = true;
      deadPlayer.x = width / 2 - deadPlayer.size / 2;
      deadPlayer.y = height / 2 - deadPlayer.size / 2;
    });
    
    // –û—á–∏—Å—Ç–∏—Ç–∏ –≤–æ—Ä–æ–≥—ñ–≤ —É —Ä–∞–¥—ñ—É—Å—ñ –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ –≥—Ä–∞–≤—Ü—è
    const clearRadius = 150;
    deadPlayers.forEach(deadPlayer => {
      enemies = enemies.filter(e => {
        const dist = Math.hypot(e.x - deadPlayer.x, e.y - deadPlayer.y);
        if (dist < clearRadius) {
          createBonusParticles(e.x + e.size/2, e.y + e.size/2, '#ff0000');
          return false;
        }
        return true;
      });
    });
    
    // –¢–µ–ª–µ–ø–æ—Ä—Ç—É–≤–∞—Ç–∏ –±–æ—Ç–∞, —è–∫—â–æ –≤—ñ–Ω —É –∑–æ–Ω—ñ –±—É–¥—å-—è–∫–æ–≥–æ –≥—Ä–∞–≤—Ü—è
    deadPlayers.forEach(deadPlayer => {
      const botDist = Math.hypot(aiBot.x - deadPlayer.x, aiBot.y - deadPlayer.y);
      if (botDist < clearRadius) {
        aiBot.x = Math.random() * width;
        aiBot.y = Math.random() * height;
      }
    });
    
    revivalsRemaining--;
    revivalModal.style.display = 'none';
    
    // –û—á–∏—Å—Ç–∏—Ç–∏ –º–∞—Å–∏–≤ –º–µ—Ä—Ç–≤–∏—Ö –≥—Ä–∞–≤—Ü—ñ–≤
    deadPlayers = [];
    
    // –ó–Ω–æ–≤—É –∑–∞–ø—É—Å—Ç–∏—Ç–∏ –≥—Ä—É
    isGameActive = true;
    
    if (!twoPlayerMode) {
      timeTimer = setInterval(() => {
        timeSec++; 
        updateCounters();
        updateDifficulty();
      }, 1000);
    }
    
    spawnTimer = setInterval(() => spawnEnemy(), enemySpawnRate);
    bonusTimer = setInterval(() => spawnBonus(), 5000);
    powerupTimer = setInterval(() => spawnRandomPowerup(), 10000);
    coinTimer = setInterval(() => spawnCoin(), 10000);
    
    animationId = requestAnimationFrame(loop);
    
    consoleLog(`–ì—Ä–∞–≤—Ü—ñ–≤ –≤—ñ–¥—Ä–æ–¥–∂–µ–Ω–æ! –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ ${revivalPrice} –º–æ–Ω–µ—Ç. –ó–∞–ª–∏—à–∏–ª–æ—Å—å –≤—ñ–¥—Ä–æ–¥–∂–µ–Ω—å: ${revivalsRemaining}`, 'success');
    
    // –ü–æ–≤—ñ–¥–æ–º–ª—è—î–º–æ —ñ–Ω—à–æ–≥–æ –≥—Ä–∞–≤—Ü—è –ø—Ä–æ –≤—ñ–¥—Ä–æ–¥–∂–µ–Ω–Ω—è
    if (isConnected) {
      sendGameCommand('player_revive');
    }
  }

  function cancelRevival() {
    clearInterval(revivalTimerId);
    revivalModal.style.display = 'none';
    waitingForRevival = false;
    deadPlayers = []; // –û—á–∏—â–∞—î–º–æ –º–∞—Å–∏–≤ –º–µ—Ä—Ç–≤–∏—Ö –≥—Ä–∞–≤—Ü—ñ–≤
    endGame();
  }

  /* ------------------ –°–ò–°–¢–ï–ú–ê –†–Ü–í–ù–Ü–í (–æ–Ω–æ–≤–ª–µ–Ω–∞) ------------------ */
  function updateDifficulty() {
    // –û–Ω–æ–≤–ª—é—î–º–æ —Ä—ñ–≤–µ–Ω—å –Ω–∞ –æ—Å–Ω–æ–≤—ñ –æ—á–æ–∫ (–∑–∞–º—ñ—Å—Ç—å —á–∞—Å—É)
    const newLevel = Math.floor(score / 500) + 1;
    if (newLevel !== level) {
      level = newLevel;
      
      // –ó–±—ñ–ª—å—à—É—î–º–æ —à–≤–∏–¥–∫—ñ—Å—Ç—å –≤–æ—Ä–æ–≥—ñ–≤ –∑ —Ä—ñ–≤–Ω–µ–º
      enemySpawnRate = Math.max(300, 1000 - level * 80);
      
      clearInterval(spawnTimer);
      spawnTimer = setInterval(() => spawnEnemy(), enemySpawnRate);
      
      consoleLog(`–î–æ—Å—è–≥–Ω—É—Ç–æ —Ä—ñ–≤–µ–Ω—å ${level}! –í–æ—Ä–æ–≥–∏ —Å—Ç–∞–ª–∏ —à–≤–∏–¥—à–∏–º–∏.`, 'success');
    }
    
    updateCounters();
  }

  /* ------------------ –°–ò–°–¢–ï–ú–ê –†–ï–ê–õ–¨–ù–û–ì–û FPS ------------------ */
  function updateFPS() {
    frameCount++;
    const now = performance.now();
    
    if (now >= lastFpsUpdate + 1000) {
      fps = Math.round((frameCount * 1000) / (now - lastFpsUpdate));
      frameCount = 0;
      lastFpsUpdate = now;
      
      if (fpsCounter) {
        fpsCounter.textContent = `FPS: ${fps}`;
      }
    }
  }

  /* ------------------ –§–£–ù–ö–¶–Ü–á –î–õ–Ø –î–í–û–• –ì–†–ê–í–¶–Ü–í ------------------ */
  function toggleTwoPlayerMode() {
    if (!isMobileDevice()) {
      twoPlayerMode = !twoPlayerMode;
      updateTwoPlayerButton();
      consoleLog(`–†–µ–∂–∏–º –¥–≤–æ—Ö –≥—Ä–∞–≤—Ü—ñ–≤ ${twoPlayerMode ? '—É–≤—ñ–º–∫–Ω–µ–Ω–∏–π' : '–≤–∏–º–∫–Ω–µ–Ω–∏–π'}`, 'success');
      
      // –û–Ω–æ–≤–ª—é—î–º–æ UI
      updateTwoPlayerUI();
    } else {
      consoleLog('–†–µ–∂–∏–º –¥–≤–æ—Ö –≥—Ä–∞–≤—Ü—ñ–≤ –¥–æ—Å—Ç—É–ø–Ω–∏–π —Ç—ñ–ª—å–∫–∏ –Ω–∞ –ü–ö/–Ω–æ—É—Ç–±—É–∫–∞—Ö', 'error');
    }
  }

  function updateTwoPlayerButton() {
    if (!twoPlayerBtn) return;
    const t = translations[currentLanguage];
    if (twoPlayerMode) {
      twoPlayerBtn.textContent = t.twoPlayerBtnOn;
      twoPlayerBtn.classList.add('active');
    } else {
      twoPlayerBtn.textContent = t.twoPlayerBtnOff;
      twoPlayerBtn.classList.remove('active');
    }
  }

  function updateTwoPlayerUI() {
    const t = translations[currentLanguage];
    if (twoPlayerMode) {
      // –î–æ–¥–∞—î–º–æ —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä –≥—Ä–∞–≤—Ü—ñ–≤
      if (!document.querySelector('.player-indicator')) {
        const indicator = document.createElement('div');
        indicator.className = 'player-indicator';
        indicator.innerHTML = `${t.player1}: <span style="color:#0af">‚ñ†</span> | ${t.player2}: <span style="color:#a52">‚ñ†</span>`;
        document.querySelector('#gameScreen').appendChild(indicator);
      }
      
      // –î–æ–¥–∞—î–º–æ –ª—ñ—á–∏–ª—å–Ω–∏–∫ –æ—á–æ–∫ –¥—Ä—É–≥–æ–≥–æ –≥—Ä–∞–≤—Ü—è
      const ui = document.querySelector('#ui .controls');
      if (ui && !document.getElementById('score2')) {
        const score2Span = document.createElement('span');
        score2Span.id = 'score2';
        score2Span.innerHTML = `${t.player2Score}: <span>0</span>`;
        ui.insertBefore(score2Span, ui.querySelector('#pauseBtn'));
      }
    } else {
      // –í–∏–¥–∞–ª—è—î–º–æ –µ–ª–µ–º–µ–Ω—Ç–∏ —Ä–µ–∂–∏–º—É –¥–≤–æ—Ö –≥—Ä–∞–≤—Ü—ñ–≤
      const indicator = document.querySelector('.player-indicator');
      if (indicator) indicator.remove();
      
      const score2El = document.getElementById('score2');
      if (score2El) score2El.remove();
    }
  }

  function isMobileDevice() {
    return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
  }

  // –í–ò–ü–†–ê–í–õ–ï–ù–ê –§–£–ù–ö–¶–Ü–Ø: –î–æ–¥–∞–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—é —Å–º–µ—Ä—Ç—ñ —á–µ—Ä–µ–∑ WebRTC
  function playerDeath(p) {
    vibrate([200, 100, 200]);
    
    // –°—Ç–≤–æ—Ä—é—î–º–æ —á–∞—Å—Ç–∏–Ω–∫–∏ —Å–º–µ—Ä—Ç—ñ
    for(let i=0;i<40;i++){
      particles.push({
        x:p.x+p.size/2,
        y:p.y+p.size/2,
        vx:(Math.random()-0.5)*4,
        vy:(Math.random()-0.5)*4,
        life:60+Math.random()*30,
        color: i%2 ? (p === player ? '#0af' : '#a52') : '#f44',
        glow: Math.random()*3+1
      });
    }
    
    p.alive = false;
    consoleLog(`${p === player ? '–ì—Ä–∞–≤–µ—Ü—å 1' : '–ì—Ä–∞–≤–µ—Ü—å 2'} –ø–æ–º–µ—Ä!`, 'error');
    
    // –î–æ–¥–∞—î–º–æ –≥—Ä–∞–≤—Ü—è –¥–æ –º–∞—Å–∏–≤—É –º–µ—Ä—Ç–≤–∏—Ö
    if (!deadPlayers.includes(p)) {
      deadPlayers.push(p);
    }
    
    // –ü–æ–≤—ñ–¥–æ–º–ª—è—î–º–æ —ñ–Ω—à–æ–≥–æ –≥—Ä–∞–≤—Ü—è –ø—Ä–æ —Å–º–µ—Ä—Ç—å
    if (isConnected && p === player) {
      sendGameCommand('player_death');
    }
    
    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —á–∏ –∑–∞–∫—ñ–Ω—á–µ–Ω–∞ –≥—Ä–∞
    if (twoPlayerMode) {
      // –£ —Ä–µ–∂–∏–º—ñ –¥–≤–æ—Ö –≥—Ä–∞–≤—Ü—ñ–≤ –ø–æ–∫–∞–∑—É—î–º–æ –≤—ñ–¥—Ä–æ–¥–∂–µ–Ω–Ω—è —Ç—ñ–ª—å–∫–∏ –∫–æ–ª–∏ –æ–±–∏–¥–≤–∞ –º–µ—Ä—Ç–≤—ñ
      if (!player.alive && !player2.alive) {
        // –û–±–∏–¥–≤–∞ –≥—Ä–∞–≤—Ü—ñ –º–µ—Ä—Ç–≤—ñ - –ø–æ–∫–∞–∑—É—î–º–æ –≤—ñ–¥—Ä–æ–¥–∂–µ–Ω–Ω—è –¥–ª—è –æ–±–æ—Ö
        showRevivalModal();
      }
      // –Ø–∫—â–æ –ª–∏—à–µ –æ–¥–∏–Ω –≥—Ä–∞–≤–µ—Ü—å –ø–æ–º–µ—Ä - –≥—Ä–∞ –ø—Ä–æ–¥–æ–≤–∂—É—î—Ç—å—Å—è
    } else {
      // –ó–≤–∏—á–∞–π–Ω–∏–π —Ä–µ–∂–∏–º - –ø–æ–∫–∞–∑—É—î–º–æ –≤—ñ–¥—Ä–æ–¥–∂–µ–Ω–Ω—è –æ–¥—Ä–∞–∑—É
      showRevivalModal();
    }
  }

  function checkPlayerCollisions() {
    for(let e of enemies){
      // –î–ª—è –≥—Ä–∞–≤—Ü—è 1
      if (player.alive &&
          e.x < player.x + player.size && e.x + e.size > player.x &&
          e.y < player.y + player.size && e.y + e.size > player.y) {
        if(!godMode){ 
          if(activeEffects.player1.shield.active){
            activeEffects.player1.shield.active = false;
            vibrate([50, 30, 50]);
            consoleLog('üõ°Ô∏è –ì—Ä–∞–≤–µ—Ü—å 1: Shield –ø–æ–≥–ª–∏–Ω—É–≤ —É–¥–∞—Ä!', 'success');
            enemies = enemies.filter(enemy => enemy !== e);
            createBonusParticles(e.x + e.size/2, e.y + e.size/2, '#00ffff');
            gameStats.enemiesKilled++;
            if (isPWA) updateQuestProgress('kill_enemies');
          } else {
            playerDeath(player);
          }
        }
      }
      
      // –î–ª—è –≥—Ä–∞–≤—Ü—è 2
      if (twoPlayerMode && player2.alive &&
          e.x < player2.x + player2.size && e.x + e.size > player2.x &&
          e.y < player2.y + player2.size && e.y + e.size > player2.y) {
        if(activeEffects.player2.shield.active){
          activeEffects.player2.shield.active = false;
          vibrate([50, 30, 50]);
          consoleLog('üõ°Ô∏è –ì—Ä–∞–≤–µ—Ü—å 2: Shield –ø–æ–≥–ª–∏–Ω—É–≤ —É–¥–∞—Ä!', 'success');
          enemies = enemies.filter(enemy => enemy !== e);
          createBonusParticles(e.x + e.size/2, e.y + e.size/2, '#00ffff');
          gameStats.enemiesKilled++;
          if (isPWA) updateQuestProgress('kill_enemies');
        } else {
          playerDeath(player2);
        }
      }
    }
  }

  // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü—ñ—ó –µ—Ñ–µ–∫—Ç—ñ–≤ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –≥—Ä–∞–≤—Ü—è
  function activatePowerup(type, playerNum){
    const playerEffects = activeEffects[playerNum];
    const now = Date.now();
    const duration = 5000; // 5 —Å–µ–∫—É–Ω–¥ –¥–ª—è –±—ñ–ª—å—à–æ—Å—Ç—ñ –µ—Ñ–µ–∫—Ç—ñ–≤
    
    // –Ø–∫—â–æ –≤–∂–µ –∞–∫—Ç–∏–≤–Ω–∏–π —Ç–∞–∫–∏–π —Å–∞–º–∏–π –µ—Ñ–µ–∫—Ç - –æ—á–∏—â–∞—î–º–æ —Ç–∞–π–º–µ—Ä–∏
    if (playerEffects[type].active) {
      // –°–∫–∏–¥–∞—î–º–æ —Å—Ç–∞—Ä–∏–π –µ—Ñ–µ–∫—Ç
      playerEffects[type].active = false;
      consoleLog(`‚ö° –ì—Ä–∞–≤–µ—Ü—å ${playerNum === 'player1' ? '1' : '2'}: ${type} –æ–Ω–æ–≤–ª–µ–Ω–æ!`, 'success');
    }
    
    switch(type){
      case 'slowMotion':
        playerEffects.slowMotion = { active: true, endTime: now + duration };
        consoleLog(`‚ö° –ì—Ä–∞–≤–µ—Ü—å ${playerNum === 'player1' ? '1' : '2'}: Slow Motion –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–æ! –í–æ—Ä–æ–≥–∏ —Å–ø–æ–≤—ñ–ª—å–Ω–µ–Ω—ñ –Ω–∞ 5 —Å–µ–∫—É–Ω–¥`, 'success');
        break;
      case 'shield':
        const shieldDuration = 20000; // 20 —Å–µ–∫—É–Ω–¥
        playerEffects.shield = { active: true, endTime: now + shieldDuration };
        consoleLog(`üõ°Ô∏è –ì—Ä–∞–≤–µ—Ü—å ${playerNum === 'player1' ? '1' : '2'}: Shield –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–æ! –ó–∞—Ö–∏—Å—Ç –≤—ñ–¥ –æ–¥–Ω–æ–≥–æ —É–¥–∞—Ä—É –Ω–∞ 20 —Å–µ–∫—É–Ω–¥`, 'success');
        
        // –¢–∞–π–º–µ—Ä –¥–ª—è –≥—Ä–∞–≤—Ü—è
        setTimeout(() => {
          if (playerEffects.shield.active) {
            playerEffects.shield.active = false;
            consoleLog(`üõ°Ô∏è –ì—Ä–∞–≤–µ—Ü—å ${playerNum === 'player1' ? '1' : '2'}: Shield –∑–∞–∫—ñ–Ω—á–∏–≤—Å—è!`, 'info');
          }
        }, shieldDuration);
        break;
      case 'speedBoost':
        playerEffects.speedBoost = { active: true, endTime: now + duration };
        consoleLog(`üöÄ –ì—Ä–∞–≤–µ—Ü—å ${playerNum === 'player1' ? '1' : '2'}: Speed Boost –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–æ! –®–≤–∏–¥–∫—ñ—Å—Ç—å –∑–±—ñ–ª—å—à–µ–Ω–∞ –Ω–∞ 5 —Å–µ–∫—É–Ω–¥`, 'success');
        break;
    }
    
    // –û–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –¥–ª—è –∫–≤–µ—Å—Ç—É
    gameStats.powerupsUsed++;
    if (isPWA) updateQuestProgress('use_powerups');
  }

  function collectBonus(bonus, p) {
    const playerNum = (p === player) ? 'player1' : 'player2';
    const playerName = (p === player) ? '–ì—Ä–∞–≤–µ—Ü—å 1' : '–ì—Ä–∞–≤–µ—Ü—å 2';
    
    if (bonus.type === 'points') {
      if (p === player) {
        score += 100;
      } else {
        score2 += 100;
      }
      updateCounters();
      createBonusParticles(bonus.x + bonus.size/2, bonus.y + bonus.size/2, '#ff0');
      consoleLog(`${playerName} –æ—Ç—Ä–∏–º–∞–≤ +100 –æ—á–æ–∫!`, 'success');
    } else if (bonus.type === 'time') {
      if (!twoPlayerMode) {
        timeSec += 5;
        updateCounters();
        createBonusParticles(bonus.x + bonus.size/2, bonus.y + bonus.size/2, '#0ff');
        consoleLog('+5 —Å–µ–∫—É–Ω–¥!', 'success');
      }
    } else {
      // Power-up –±–æ–Ω—É—Å–∏ - –∞–∫—Ç–∏–≤—É—î–º–æ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –≥—Ä–∞–≤—Ü—è
      activatePowerup(bonus.type, playerNum);
      createBonusParticles(bonus.x + bonus.size/2, bonus.y + bonus.size/2, bonus.color);
    }
  }

  /* ------------------ –§—É–Ω–∫—Ü—ñ—ó –≥—Ä–∏ ------------------ */
  function resize(){
    width=innerWidth; height=innerHeight;
    canvas.width=width; canvas.height=height;
    player.size = Math.max(24, Math.min(width,height)*0.045);
    player.speed = Math.max(3, Math.min(width,height)*0.012);
    if (twoPlayerMode) {
      player2.size = player.size;
      player2.speed = player.speed;
    }
    stars=[];
    for(let i=0;i<150;i++){
      stars.push({x:Math.random()*width, y:Math.random()*height, r:Math.random()*2+0.5, speed:Math.random()*0.1+0.03});
    }
  }
  addEventListener('resize', resize);

  function showScreen(id){
    menu.style.display = (id==='menu')?'flex':'none';
    gameScreen.style.display = (id==='game')?'flex':'none';
    gameOver.style.display = (id==='over')?'flex':'none';
    
    pauseModal.style.display = 'none';
    revivalModal.style.display = 'none';
    isGamePaused = false;
    
    if(id==='menu') {
      updateCounters();
      playMenuMusic();
    } else if(id==='game') {
      playGameMusic();
    } else if(id==='over') {
      updateGameOverCounters();
      stopGameMusic();
    }
  }

  function resetGameState(){
    cancelAnimationFrame(animationId);
    clearInterval(timeTimer);
    clearInterval(spawnTimer);
    clearInterval(bonusTimer);
    clearInterval(powerupTimer);
    clearInterval(coinTimer);
    if (revivalTimerId) clearInterval(revivalTimerId);
    
    enemies=[]; particles=[]; bonuses=[]; coins=[];
    isGameOverAnim=false;
    isGameActive=false;
    isGamePaused=false;
    waitingForRevival = false;
    deadPlayers = [];
    score = 0;
    score2 = 0;
    level = 1;
    enemySpawnRate = 1000;
    revivalsRemaining = 3;
    revivalPrice = 1;
    
    // –°–∫–∏–¥–∞—î–º–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    gameStats = {
      timeSurvived: 0,
      coinsCollected: 0,
      enemiesKilled: 0,
      powerupsUsed: 0
    };
    
    activeEffects = {
      player1: {
        slowMotion: { active: false, endTime: 0 },
        shield: { active: false, endTime: 0 },
        speedBoost: { active: false, endTime: 0 }
      },
      player2: {
        slowMotion: { active: false, endTime: 0 },
        shield: { active: false, endTime: 0 },
        speedBoost: { active: false, endTime: 0 }
      }
    };
    player.alive = true;
    player2.alive = true;
    pauseModal.style.display = 'none';
    revivalModal.style.display = 'none';
    document.getElementById("repoBtn").style.display = "block";
  }

  function toggleBot() {
    botEnabled = !botEnabled;
    updateBotButton();
    consoleLog(`–ë–æ—Ç ${botEnabled ? '—É–≤—ñ–º–∫–Ω–µ–Ω–∏–π' : '–≤–∏–º–∫–Ω–µ–Ω–∏–π'}`, 'success');
  }

  function updateBotButton() {
    const t = translations[currentLanguage];
    if (botEnabled) {
      botBtn.textContent = t.botBtnOn;
      botBtn.classList.add('active');
    } else {
      botBtn.textContent = t.botBtnOff;
      botBtn.classList.remove('active');
    }
  }

  function startGame(){
    resetGameState(); resize();
    player.x=width/2-player.size/2 - (twoPlayerMode ? 50 : 0);
    player.y=height/2-player.size/2;
    player.alive = true;
    
    if (twoPlayerMode) {
      player2.x = width/2 - player2.size/2 + 50;
      player2.y = height/2 - player2.size/2;
      player2.alive = true;
      score2 = 0;
      
      // –ü—Ä–∏—Ö–æ–≤—É—î–º–æ —Ç–∞–π–º–µ—Ä —ñ —Ä–µ–∫–æ—Ä–¥ –¥–ª—è —Ä–µ–∂–∏–º—É –¥–≤–æ—Ö –≥—Ä–∞–≤—Ü—ñ–≤
      if (document.querySelectorAll('#ui .controls span')[0]) {
        document.querySelectorAll('#ui .controls span')[0].style.display = 'none';
      }
      if (document.querySelectorAll('#ui .controls span')[1]) {
        document.querySelectorAll('#ui .controls span')[1].style.display = 'none';
      }
      
      updateTwoPlayerUI();
    } else {
      // –ü–æ–∫–∞–∑—É—î–º–æ —Ç–∞–π–º–µ—Ä —ñ —Ä–µ–∫–æ—Ä–¥ –¥–ª—è –∑–≤–∏—á–∞–π–Ω–æ–≥–æ —Ä–µ–∂–∏–º—É
      if (document.querySelectorAll('#ui .controls span')[0]) {
        document.querySelectorAll('#ui .controls span')[0].style.display = '';
      }
      if (document.querySelectorAll('#ui .controls span')[1]) {
        document.querySelectorAll('#ui .controls span')[1].style.display = '';
      }
    }
    
    aiBot.x = Math.random() * width;
    aiBot.y = Math.random() * height;
    aiBot.size = player.size * 0.9;
    aiBot.speed = 0.7 + Math.min(1.5, best * 0.025);
    timeSec = 0; 
    score = 0; 
    level = 1;
    document.getElementById("repoBtn").style.display = "none";

    best = parseInt(localStorage.getItem('bestTime')) || 0;
    bestScore = parseInt(localStorage.getItem('bestScore')) || 0;

    if (!twoPlayerMode) {
      timeTimer=setInterval(()=>{
        timeSec++; 
        updateCounters();
        updateDifficulty();
        
        // –û–Ω–æ–≤–ª—é—î–º–æ –∫–≤–µ—Å—Ç –≤–∏–∂–∏–≤–∞–Ω–Ω—è
        if (isPWA) {
          updateQuestProgress('survive_30');
        }
      },1000);
    }
    
    spawnTimer=setInterval(()=>spawnEnemy(),enemySpawnRate);
    bonusTimer=setInterval(()=>spawnBonus(),5000);
    powerupTimer=setInterval(()=>spawnRandomPowerup(),10000);
    coinTimer=setInterval(()=>spawnCoin(),10000); // –ú–æ–Ω–µ—Ç–∞ –∫–æ–∂–Ω—ñ 10 —Å–µ–∫—É–Ω–¥
    
    isGameActive=true;
    updateCounters();
    
    // –°–∫–∏–¥–∞—î–º–æ FPS –ª—ñ—á–∏–ª—å–Ω–∏–∫
    frameCount = 0;
    lastFpsUpdate = performance.now();
    fps = 0;
    if (fpsCounter) fpsCounter.textContent = 'FPS: 0';
    
    animationId=requestAnimationFrame(loop);
    
    // –ü–æ–≤—ñ–¥–æ–º–ª—è—î–º–æ —ñ–Ω—à–æ–≥–æ –≥—Ä–∞–≤—Ü—è –ø—Ä–æ —Å—Ç–∞—Ä—Ç –≥—Ä–∏
    if (isConnected) {
      sendGameCommand('start');
    }
  }

  // –í–ò–ü–†–ê–í–õ–ï–ù–ê –§–£–ù–ö–¶–Ü–Ø: –¥–æ–¥–∞–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—é –ø–∞—É–∑–∏
  function togglePause(){
    if(!isGameActive || isGameOverAnim || waitingForRevival) return;

    isGamePaused = !isGamePaused;
    pauseModal.style.display = isGamePaused ? 'flex' : 'none';

    if(isGamePaused){
      cancelAnimationFrame(animationId);
      clearInterval(timeTimer);
      clearInterval(spawnTimer);
      clearInterval(bonusTimer);
      clearInterval(powerupTimer);
      clearInterval(coinTimer);
      stopGameMusic();
      
      // –ü–æ–≤—ñ–¥–æ–º–ª—è—î–º–æ —ñ–Ω—à–æ–≥–æ –≥—Ä–∞–≤—Ü—è –ø—Ä–æ –ø–∞—É–∑—É
      if (isConnected) {
        sendGameCommand('pause');
      }
    } else {
      if (!twoPlayerMode) {
        timeTimer=setInterval(()=>{
          timeSec++; 
          updateCounters();
          updateDifficulty();
        },1000);
      }
      spawnTimer=setInterval(()=>spawnEnemy(),enemySpawnRate);
      bonusTimer=setInterval(()=>spawnBonus(),5000);
      powerupTimer=setInterval(()=>spawnRandomPowerup(),15000);
      coinTimer=setInterval(()=>spawnCoin(),10000);
      animationId=requestAnimationFrame(loop);
      playGameMusic();
      
      // –ü–æ–≤—ñ–¥–æ–º–ª—è—î–º–æ —ñ–Ω—à–æ–≥–æ –≥—Ä–∞–≤—Ü—è –ø—Ä–æ –ø—Ä–æ–¥–æ–≤–∂–µ–Ω–Ω—è
      if (isConnected) {
        sendGameCommand('resume');
      }
    }
    document.getElementById("repoBtn").style.display = "none";
  }

  function endGame(){
    clearInterval(timeTimer);
    clearInterval(spawnTimer);
    clearInterval(bonusTimer);
    clearInterval(powerupTimer);
    clearInterval(coinTimer);
    isGameActive=false;
    isGamePaused = false;
    pauseModal.style.display = 'none';
    revivalModal.style.display = 'none';
    
    for(let i=0;i<80;i++){
      particles.push({
        x:player.x+player.size/2,
        y:player.y+player.size/2,
        vx:(Math.random()-0.5)*4,
        vy:(Math.random()-0.5)*4,
        life:60+Math.random()*30,
        color:i%2?'#0af':'#f44',
        glow: Math.random()*3+1
      });
    }
    isGameOverAnim=true;
    
    // –ü–æ–≤—ñ–¥–æ–º–ª—è—î–º–æ —ñ–Ω—à–æ–≥–æ –≥—Ä–∞–≤—Ü—è –ø—Ä–æ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –≥—Ä–∏
    if (isConnected) {
      sendGameCommand('over');
    }
  }

  function spawnEnemy(){
    const types = ['normal', 'fast', 'big', 'smart'];
    const type = types[Math.floor(Math.random() * types.length)];
    
    const size = type === 'big' ? 40 : type === 'fast' ? 15 : 25;
    const speed = type === 'fast' ? 3 : type === 'smart' ? 1 : 1.5 + Math.random();
    
    let x, y, vx = 0, vy = 0;
    const edge = Math.floor(Math.random() * 4);
    
    if(edge===0){x=-size;y=Math.random()*height;vx=speed;}
    if(edge===1){x=width+size;y=Math.random()*height;vx=-speed;}
    if(edge===2){x=Math.random()*width;y=-size;vy=speed;}
    if(edge===3){x=Math.random()*width;y=height+size;vy=-speed;}
    
    enemies.push({x, y, vx, vy, size, type});
  }

  function spawnBonus(){
    if(bonuses.length < 3) {
      bonuses.push({
        x: Math.random() * (width - 20),
        y: Math.random() * (height - 20),
        size: 15,
        type: Math.random() > 0.7 ? 'time' : 'points',
        life: 300
      });
    }
  }

  // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è —Å–ø–∞–≤–Ω—É –≤–∏–ø–∞–¥–∫–æ–≤–æ–≥–æ power-up
  function spawnRandomPowerup(){
    const powerups = ['slowMotion', 'shield', 'speedBoost'];
    const randomPowerup = powerups[Math.floor(Math.random() * powerups.length)];
    
    bonuses.push({
      x: Math.random() * (width - 25),
      y: Math.random() * (height - 25),
      size: 20,
      type: randomPowerup,
      life: 300,
      color: randomPowerup === 'slowMotion' ? '#ff00ff' : 
             randomPowerup === 'shield' ? '#00ffff' : '#ffff00'
    });
  }
function updateEffects(deltaTime){
    const now = Date.now();
    
    // –û–Ω–æ–≤–ª—é—î–º–æ –µ—Ñ–µ–∫—Ç–∏ –¥–ª—è –æ–±–æ—Ö –≥—Ä–∞–≤—Ü—ñ–≤
    ['player1', 'player2'].forEach(playerNum => {
      for(let effect in activeEffects[playerNum]){
        if(activeEffects[playerNum][effect].active && now > activeEffects[playerNum][effect].endTime){
          activeEffects[playerNum][effect].active = false;
          consoleLog(`${playerNum === 'player1' ? '–ì—Ä–∞–≤–µ—Ü—å 1' : '–ì—Ä–∞–≤–µ—Ü—å 2'}: ${effect} –∑–∞–∫—ñ–Ω—á–∏–≤—Å—è`, 'info');
        }
      }
    });
  }

  function updateBodyguardBot(deltaTime){
    if(!bodyguardBot.active) return;
    
    // –ë–æ—Ç-–æ—Ö–æ—Ä–æ–Ω–µ—Ü—å –∑–∞—Ö–∏—â–∞—î —Ç—ñ–ª—å–∫–∏ –≥—Ä–∞–≤—Ü—è 1
    if (!player.alive) return;
    
    // –†—É—Ö –ø–æ –∫–æ–ª—É –Ω–∞–≤–∫–æ–ª–æ –≥—Ä–∞–≤—Ü—è
    bodyguardBot.angle += 0.05 * deltaTime;
    const radius = 80;
    bodyguardBot.x = player.x + player.size/2 + Math.cos(bodyguardBot.angle) * radius - bodyguardBot.size/2;
    bodyguardBot.y = player.y + player.size/2 + Math.sin(bodyguardBot.angle) * radius - bodyguardBot.size/2;
    
    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑—ñ—Ç–∫–Ω–µ–Ω—å –∑ –≤–æ—Ä–æ–≥–∞–º–∏
    for(let i = enemies.length - 1; i >= 0; i--){
      const e = enemies[i];
      if(
        bodyguardBot.x < e.x + e.size &&
        bodyguardBot.x + bodyguardBot.size > e.x &&
        bodyguardBot.y < e.y + e.size &&
        bodyguardBot.y + bodyguardBot.size > e.y
      ){
        // 25% —à–∞–Ω—Å –∑–Ω–∏—â–∏—Ç–∏ –≤–æ—Ä–æ–≥–∞
        if(Math.random() < 0.25){
          enemies.splice(i, 1);
          createBonusParticles(e.x + e.size/2, e.y + e.size/2, '#00ff00');
          consoleLog('üõ°Ô∏è –ë–æ—Ç-–æ—Ö–æ—Ä–æ–Ω–µ—Ü—å –∑–Ω–∏—â–∏–≤ –≤–æ—Ä–æ–≥–∞!', 'success');
          gameStats.enemiesKilled++;
          if (isPWA) updateQuestProgress('kill_enemies');
        }
      }
    }
  }

  function createBonusParticles(x, y, color) {
    for(let i=0;i<20;i++){
      particles.push({
        x: x,
        y: y,
        vx: (Math.random()-0.5)*3,
        vy: (Math.random()-0.5)*3,
        life: 30+Math.random()*20,
        color: color,
        glow: Math.random()*2+1
      });
    }
  }

  // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤—ñ–±—Ä–∞—Ü—ñ—ó
  function vibrate(pattern) {
    if (vibrationEnabled && navigator.vibrate) {
      navigator.vibrate(pattern);
    }
  }

  function update(deltaTime){
    if(isGamePaused || waitingForRevival) return;

    if(isGameActive){
      // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –µ—Ñ–µ–∫—Ç—ñ–≤
      updateEffects(deltaTime);
      
      // –†—É—Ö –≥—Ä–∞–≤—Ü—è 1 –∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º speed boost
      let currentSpeed1 = player.speed;
      if(activeEffects.player1.speedBoost.active) currentSpeed1 *= 1.6;

      // –†—É—Ö –≥—Ä–∞–≤—Ü—è 1 (WASD) - –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –º–∞–ª–µ–Ω—å–∫—ñ –ª—ñ—Ç–µ—Ä–∏
      if(keys['w']) player.y -= currentSpeed1 * deltaTime * fpsScale;
      if(keys['s']) player.y += currentSpeed1 * deltaTime * fpsScale;
      if(keys['a']) player.x -= currentSpeed1 * deltaTime * fpsScale;
      if(keys['d']) player.x += currentSpeed1 * deltaTime * fpsScale;

      // –†—É—Ö –≥—Ä–∞–≤—Ü—è 2 (—Å—Ç—Ä—ñ–ª–∫–∏) —Ç—ñ–ª—å–∫–∏ –≤ —Ä–µ–∂–∏–º—ñ –¥–≤–æ—Ö –≥—Ä–∞–≤—Ü—ñ–≤
      if (twoPlayerMode && player2.alive) {
        let currentSpeed2 = player2.speed;
        if(activeEffects.player2.speedBoost.active) currentSpeed2 *= 1.6;
        
        // –î–ª—è —Å—Ç—Ä—ñ–ª–æ–∫ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω—ñ –∑–Ω–∞—á–µ–Ω–Ω—è
        if(keys['ArrowUp']) player2.y -= currentSpeed2 * deltaTime * fpsScale;
        if(keys['ArrowDown']) player2.y += currentSpeed2 * deltaTime * fpsScale;
        if(keys['ArrowLeft']) player2.x -= currentSpeed2 * deltaTime * fpsScale;
        if(keys['ArrowRight']) player2.x += currentSpeed2 * deltaTime * fpsScale;
        
        player2.x=Math.max(0,Math.min(player2.x,width-player2.size));
        player2.y=Math.max(0,Math.min(player2.y,height-player2.size));
      }

      if(joystick.active){
        player.x += joystick.dx * currentSpeed1 * deltaTime * fpsScale;
        player.y += joystick.dy * currentSpeed1 * deltaTime * fpsScale;
      }

      player.x=Math.max(0,Math.min(player.x,width-player.size));
      player.y=Math.max(0,Math.min(player.y,height-player.size));

      // –†—É—Ö AI –±–æ—Ç–∞ (–ø–µ—Ä–µ—Å–ª—ñ–¥—É—î –Ω–∞–π–±–ª–∏–∂—á–æ–≥–æ –∂–∏–≤–æ–≥–æ –≥—Ä–∞–≤—Ü—è)
      if (botEnabled) {

        // –í–∏–±—ñ—Ä —Ü—ñ–ª—ñ –∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º —Ç–æ–≥–æ, —Ö—Ç–æ –∂–∏–≤–∏–π
        let targetPlayer = null;

        // –Ø–∫—â–æ –∂–∏–≤–∏–π –ª–∏—à–µ –≥—Ä–∞–≤–µ—Ü—å 1
        if (player.alive && (!twoPlayerMode || !player2.alive)) {
          targetPlayer = player;
        }
        // –Ø–∫—â–æ –∂–∏–≤–∏–π –ª–∏—à–µ –≥—Ä–∞–≤–µ—Ü—å 2
        else if (twoPlayerMode && player2.alive && !player.alive) {
            targetPlayer = player2;
        }
        // –Ø–∫—â–æ –æ–±–∏–¥–≤–∞ –∂–∏–≤—ñ
        else if (player.alive && player2.alive) {
            const distToP1 = Math.hypot(player.x - aiBot.x, player.y - aiBot.y);
            const distToP2 = Math.hypot(player2.x - aiBot.x, player2.y - aiBot.y);
            targetPlayer = distToP1 < distToP2 ? player : player2;
        }

        // –Ø–∫—â–æ –Ω—ñ—Ö—Ç–æ –Ω–µ –∂–∏–≤–∏–π ‚Äî –±–æ—Ç —Å—Ç–æ—ó—Ç—å
        if (!targetPlayer) {
            // –º–æ–∂–µ—à –¥–æ–¥–∞—Ç–∏ –∞–Ω—ñ–º–∞—Ü—ñ—é —Å—Ç–æ—è–Ω–Ω—è —è–∫—â–æ —Ç—Ä–µ–±–∞
        } else {

            const dx = targetPlayer.x - aiBot.x;
            const dy = targetPlayer.y - aiBot.y;
            const dist = Math.hypot(dx, dy);

            if (dist > 1) {
              aiBot.x += (dx / dist) * aiBot.speed * deltaTime * fpsScale;
              aiBot.y += (dy / dist) * aiBot.speed * deltaTime * fpsScale;
            }
        }

        // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑—ñ—Ç–∫–Ω–µ–Ω–Ω—è –∑ –≥—Ä–∞–≤—Ü–µ–º 1
        if (player.alive && !godMode && 
            aiBot.x < player.x + player.size &&
            aiBot.x + aiBot.size > player.x &&
            aiBot.y < player.y + player.size &&
            aiBot.y + aiBot.size > player.y) {
          playerDeath(player);
        }
        
        // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑—ñ—Ç–∫–Ω–µ–Ω–Ω—è –∑ –≥—Ä–∞–≤—Ü–µ–º 2
        if (twoPlayerMode && player2.alive && 
            aiBot.x < player2.x + player2.size &&
            aiBot.x + aiBot.size > player2.x &&
            aiBot.y < player2.y + player2.size &&
            aiBot.y + aiBot.size > player2.y) {
          playerDeath(player2);
        }
      }

      // –†—É—Ö –≤–æ—Ä–æ–≥—ñ–≤ –∑ —É—Ä–∞—Ö—É–≤–∞–Ω–Ω—è–º slow motion
      let enemySpeedMultiplier = 1;
      // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —Ö—Ç–æ—Å—å —ñ–∑ –≥—Ä–∞–≤—Ü—ñ–≤ –º–∞—î –∞–∫—Ç–∏–≤–Ω–∏–π slow motion
      if(activeEffects.player1.slowMotion.active || activeEffects.player2.slowMotion.active) {
        enemySpeedMultiplier = 0.35;
      }
      
      for(let e of enemies){ 
        e.x += e.vx * enemySpeedMultiplier * deltaTime * fpsScale; 
        e.y += e.vy * enemySpeedMultiplier * deltaTime * fpsScale; 
      }
      enemies = enemies.filter(e => e.x > -200 && e.x < width+200 && e.y > -200 && e.y < height+200);

      // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑—ñ—Ç–∫–Ω–µ–Ω—å –≥—Ä–∞–≤—Ü—ñ–≤ –∑ –≤–æ—Ä–æ–≥–∞–º–∏
      checkPlayerCollisions();
      
      // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –±–æ—Ç–∞-–æ—Ö–æ—Ä–æ–Ω—Ü—è
      updateBodyguardBot(deltaTime);
      
      // –û–±—Ä–æ–±–∫–∞ –º–æ–Ω–µ—Ç
      coins = coins.filter(coin => {
        coin.life -= deltaTime * fpsScale;
        if (coin.life <= 0) return false;
        
        // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥–ª—è –≥—Ä–∞–≤—Ü—è 1
        if (player.alive && 
            player.x < coin.x + coin.size && player.x + player.size > coin.x &&
            player.y < coin.y + coin.size && player.y + player.size > coin.y) {
          addCoin(1);
          createBonusParticles(coin.x + coin.size/2, coin.y + coin.size/2, '#ffd700');
          gameStats.coinsCollected++;
          consoleLog('ü™ô –ó—ñ–±—Ä–∞–Ω–æ –º–æ–Ω–µ—Ç—É!', 'success');
          return false;
        }
        
        // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥–ª—è –≥—Ä–∞–≤—Ü—è 2
        if (twoPlayerMode && player2.alive &&
            player2.x < coin.x + coin.size && player2.x + player2.size > coin.x &&
            player2.y < coin.y + coin.size && player2.y + player2.size > coin.y) {
          addCoin(1);
          createBonusParticles(coin.x + coin.size/2, coin.y + coin.size/2, '#ffd700');
          gameStats.coinsCollected++;
          consoleLog('ü™ô –ì—Ä–∞–≤–µ—Ü—å 2 –∑—ñ–±—Ä–∞–≤ –º–æ–Ω–µ—Ç—É!', 'success');
          return false;
        }
        return true;
      });

      // –û–±—Ä–æ–±–∫–∞ –±–æ–Ω—É—Å—ñ–≤ –¥–ª—è –æ–±–æ—Ö –≥—Ä–∞–≤—Ü—ñ–≤
      bonuses = bonuses.filter(bonus => {
        bonus.life -= deltaTime * fpsScale;
        if (bonus.life <= 0) return false;
        
        // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥–ª—è –≥—Ä–∞–≤—Ü—è 1
        if (player.alive && 
            player.x < bonus.x + bonus.size && player.x + player.size > bonus.x &&
            player.y < bonus.y + bonus.size && player.y + player.size > bonus.y) {
          collectBonus(bonus, player);
          return false;
        }
        
        // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥–ª—è –≥—Ä–∞–≤—Ü—è 2
        if (twoPlayerMode && player2.alive &&
            player2.x < bonus.x + bonus.size && player2.x + player2.size > bonus.x &&
            player2.y < bonus.y + bonus.size && player2.y + player2.size > bonus.y) {
          collectBonus(bonus, player2);
          return false;
        }
        return true;
      });
      
      // –í—ñ–¥–ø—Ä–∞–≤–∫–∞ —Å—Ç–∞–Ω—É –≥—Ä–∏ —ñ–Ω—à–æ–º—É –≥—Ä–∞–≤—Ü—é
      sendGameState();
    }

    for(let p of particles){
      p.x += p.vx * deltaTime * fpsScale;
      p.y += p.vy * deltaTime * fpsScale;
      p.life -= deltaTime * fpsScale;
    }
    particles = particles.filter(p => p.life > 0);

    for(let s of stars){
      s.y += s.speed * deltaTime * fpsScale;
      if(s.y > height) s.y = 0;
    }

    if(isGameOverAnim && particles.length===0){
      isGameOverAnim=false;
      showScreen('over');
      if(!twoPlayerMode) {
        if(timeSec>best){
          best=timeSec; 
          localStorage.setItem('bestTime',best);
        }
        if(score>bestScore){
          bestScore=score;
          localStorage.setItem('bestScore',bestScore);
        }
      }
      updateGameOverCounters();
      updateCounters();

      aiBot.speed = 0.4 + Math.min(2.5, timeSec * 0.01);
    }
  }
  
  function draw(){
    ctx.clearRect(0,0,width,height);

    for(let s of stars){
      ctx.fillStyle = 'white';
      ctx.globalAlpha = Math.random()*0.8+0.2;
      ctx.beginPath();
      ctx.arc(s.x,s.y,s.r,0,Math.PI*2);
      ctx.fill();
    }
    ctx.globalAlpha=1;

    // –ú–∞–ª—é–≤–∞–Ω–Ω—è –≥—Ä–∞–≤—Ü—è 1 (—è–∫—â–æ –∂–∏–≤–∏–π)
    if(player.alive){
      // –í–∏–∑–Ω–∞—á–∞—î–º–æ –∫–æ–ª—ñ—Ä –Ω–∞ –æ—Å–Ω–æ–≤—ñ –∞–∫—Ç–∏–≤–Ω–∏—Ö –µ—Ñ–µ–∫—Ç—ñ–≤
      if(activeEffects.player1.shield.active){
        ctx.fillStyle='#00ffff';
      } else if(activeEffects.player1.speedBoost.active){
        ctx.fillStyle='#ffff00';
      } else {
        ctx.fillStyle='#0af';
      }
      ctx.fillRect(player.x,player.y,player.size,player.size);
      
      // –î–æ–¥–∞—î–º–æ –≤—ñ–∑—É–∞–ª—å–Ω–∏–π –µ—Ñ–µ–∫—Ç –¥–ª—è —â–∏—Ç–∞
      if(activeEffects.player1.shield.active){
        ctx.strokeStyle = '#00ffff';
        ctx.lineWidth = 3;
        ctx.globalAlpha = 0.5;
        ctx.strokeRect(player.x - 3, player.y - 3, player.size + 6, player.size + 6);
        ctx.globalAlpha = 1;
      }
    }

    // –ú–∞–ª—é–≤–∞–Ω–Ω—è –≥—Ä–∞–≤—Ü—è 2 (—Ç–µ–º–Ω–æ-–∫–æ—Ä–∏—á–Ω–µ–≤–∏–π, —è–∫—â–æ –∂–∏–≤–∏–π)
    if (twoPlayerMode && player2.alive) {
      // –í–∏–∑–Ω–∞—á–∞—î–º–æ –∫–æ–ª—ñ—Ä –Ω–∞ –æ—Å–Ω–æ–≤—ñ –∞–∫—Ç–∏–≤–Ω–∏—Ö –µ—Ñ–µ–∫—Ç—ñ–≤
      if(activeEffects.player2.shield.active){
        ctx.fillStyle='#ffa500'; // –ü–æ–º–∞—Ä–∞–Ω—á–µ–≤–∏–π –¥–ª—è —â–∏—Ç–∞
      } else if(activeEffects.player2.speedBoost.active){
        ctx.fillStyle='#ffdd00'; // –Ø—Å–∫—Ä–∞–≤–æ-–∂–æ–≤—Ç–∏–π –¥–ª—è speed boost
      } else {
        ctx.fillStyle='#a52';
      }
      ctx.fillRect(player2.x,player2.y,player2.size,player2.size);
      
      // –î–æ–¥–∞—î–º–æ –≤—ñ–∑—É–∞–ª—å–Ω–∏–π –µ—Ñ–µ–∫—Ç –¥–ª—è —â–∏—Ç–∞
      if(activeEffects.player2.shield.active){
        ctx.strokeStyle = '#ffa500';
        ctx.lineWidth = 3;
        ctx.globalAlpha = 0.5;
        ctx.strokeRect(player2.x - 3, player2.y - 3, player2.size + 6, player2.size + 6);
        ctx.globalAlpha = 1;
      }
    }

    ctx.fillStyle='#f44';
    for(let e of enemies) ctx.fillRect(e.x,e.y,e.size,e.size);
    
    // –ú–∞–ª—é–≤–∞–Ω–Ω—è –º–æ–Ω–µ—Ç
    for(let coin of coins){
      ctx.fillStyle = '#ffd700';
      ctx.globalAlpha = Math.max(0.3, coin.life / 300);
      ctx.beginPath();
      ctx.arc(coin.x + coin.size/2, coin.y + coin.size/2, coin.size/2, 0, Math.PI * 2);
      ctx.fill();
      ctx.globalAlpha = 1;
    }
    
    // –ú–∞–ª—é–≤–∞–Ω–Ω—è AI –±–æ—Ç–∞
    if (botEnabled) {
      ctx.fillStyle = '#c00';
      ctx.fillRect(aiBot.x, aiBot.y, aiBot.size, aiBot.size);
    }
    
    // –ú–∞–ª—é–≤–∞–Ω–Ω—è –±–æ—Ç–∞-–æ—Ö–æ—Ä–æ–Ω—Ü—è
    if(bodyguardBot.active){
      ctx.fillStyle = '#00ff00';
      ctx.fillRect(bodyguardBot.x, bodyguardBot.y, bodyguardBot.size, bodyguardBot.size);
    }

    // –ú–∞–ª—é–≤–∞–Ω–Ω—è –±–æ–Ω—É—Å—ñ–≤
    for(let bonus of bonuses){
      ctx.fillStyle = bonus.color || (bonus.type === 'points' ? '#ff0' : '#0ff');
      ctx.globalAlpha = Math.max(0.3, bonus.life / 300);
      ctx.fillRect(bonus.x, bonus.y, bonus.size, bonus.size);
      ctx.globalAlpha = 1;
    }

    for(let p of particles){
      ctx.fillStyle=p.color;
      ctx.globalAlpha = Math.max(0,p.life/60);
      ctx.shadowBlur = p.glow||0;
      ctx.shadowColor = p.color;
      ctx.fillRect(p.x,p.y,3,3);
      ctx.globalAlpha=1;
      ctx.shadowBlur = 0;
    }

    if(joystick.active){
      ctx.strokeStyle='rgba(0,255,0,0.3)';
      ctx.lineWidth=2;
      ctx.beginPath();
      ctx.arc(joystick.x,joystick.y,40,0,Math.PI*2);
      ctx.stroke();
      ctx.fillStyle='rgba(0,255,0,0.4)';
      ctx.beginPath();
      ctx.arc(joystick.x+joystick.dx*30,joystick.y+joystick.dy*30,12,0,Math.PI*2);
      ctx.fill();
    }
  }

  function loop(currentTime){
    if (!lastTime) lastTime = currentTime;
    
    // –û–±–º–µ–∂–µ–Ω–Ω—è FPS
    const elapsed = currentTime - lastTime;
    const targetFrameTime = 1000 / fpsLimit;
    
    if (elapsed < targetFrameTime) {
      // –ó–∞–Ω–∞–¥—Ç–æ —Ä–∞–Ω–æ –¥–ª—è –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ –∫–∞–¥—Ä—É, —á–µ–∫–∞—î–º–æ
      animationId = requestAnimationFrame(loop);
      return;
    }
    
    const deltaTime = elapsed / 1000;
    lastTime = currentTime - (elapsed % targetFrameTime);
    
    // –û–Ω–æ–≤–ª—é—î–º–æ FPS –ª—ñ—á–∏–ª—å–Ω–∏–∫
    updateFPS();
    
    update(deltaTime); 
    draw(); 
    animationId = requestAnimationFrame(loop); 
  }

  /* ------------------ –§—É–Ω–∫—Ü—ñ—ó –¥–ª—è –º—É–∑–∏–∫–∏ ------------------ */
  function playMenuMusic() {
    if (!menuMusicEnabled) {
      stopMenuMusic();
      return;
    }
    stopGameMusic();
    menuMusic.play().catch(e => {
      if (!musicAutoplayAttempted) {
        console.log('–ê–≤—Ç–æ–≤—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è –º—É–∑–∏–∫–∏ –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ, –±—É–¥–µ –≤–∫–ª—é—á–µ–Ω–æ –ø—Ä–∏ –≤–∑–∞—î–º–æ–¥—ñ—ó');
        musicAutoplayAttempted = true;
      }
    });
  }

  function playGameMusic() {
    if (!gameMusicEnabled) {
      stopGameMusic();
      return;
    }
    stopMenuMusic();
    gameMusic.play().catch(e => {
      if (!musicAutoplayAttempted) {
        console.log('–ê–≤—Ç–æ–≤—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è –º—É–∑–∏–∫–∏ –≥—Ä–∏ –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ');
        musicAutoplayAttempted = true;
      }
    });
  }

  function stopGameMusic() {
    gameMusic.pause();
    gameMusic.currentTime = 0;
  }

  function stopMenuMusic() {
    menuMusic.pause();
    menuMusic.currentTime = 0;
  }

  function stopAllMusic() {
    stopMenuMusic();
    stopGameMusic();
  }

  // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –ø—Ä–∏–º—É—Å–æ–≤–æ–≥–æ –∑–∞–ø—É—Å–∫—É –º—É–∑–∏–∫–∏ –ø—Ä–∏ –≤–∑–∞—î–º–æ–¥—ñ—ó –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
  function forcePlayMusic() {
    musicAutoplayAttempted = true;
    if (menu.style.display === 'flex' && menuMusicEnabled) {
      playMenuMusic();
    } else if (gameScreen.style.display === 'flex' && gameMusicEnabled && !isGamePaused) {
      playGameMusic();
    }
  }

  /* ------------------ –§—É–Ω–∫—Ü—ñ—ó –¥–ª—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å ------------------ */
  function openSettings() {
    settingsModal.style.display = 'flex';
  }

  function closeSettings() {
    settingsModal.style.display = 'none';
    saveSettings();
  }

  function saveSettings() {
    currentLanguage = languageSelect.value;
    menuMusicEnabled = menuMusicToggle.checked;
    gameMusicEnabled = gameMusicToggle.checked;
    vibrationEnabled = vibrationToggle.checked;
    fpsLimit = parseInt(fpsSelect.value);
    
    localStorage.setItem('language', currentLanguage);
    localStorage.setItem('menuMusicEnabled', menuMusicEnabled);
    localStorage.setItem('gameMusicEnabled', gameMusicEnabled);
    localStorage.setItem('vibrationEnabled', vibrationEnabled);
    localStorage.setItem('fpsLimit', fpsLimit);
    
    updateLanguage();
    
    // –ú–∏—Ç—Ç—î–≤–µ –≤–∏–º–∏–∫–∞–Ω–Ω—è/–≤–º–∏–∫–∞–Ω–Ω—è –º—É–∑–∏–∫–∏
    if (!menuMusicEnabled) {
      stopMenuMusic();
    } else if (menu.style.display === 'flex') {
      playMenuMusic();
    }
    
    if (!gameMusicEnabled) {
      stopGameMusic();
    } else if (gameScreen.style.display === 'flex' && !isGamePaused) {
      playGameMusic();
    }
  }

  function loadSettings() {
    const savedLanguage = localStorage.getItem('language');
    const savedMenuMusic = localStorage.getItem('menuMusicEnabled');
    const savedGameMusic = localStorage.getItem('gameMusicEnabled');
    const savedVibration = localStorage.getItem('vibrationEnabled');
    const savedFPSLimit = localStorage.getItem('fpsLimit');
    
    if (savedLanguage) {
      currentLanguage = savedLanguage;
      languageSelect.value = currentLanguage;
    }
    
    if (savedMenuMusic !== null) {
      menuMusicEnabled = savedMenuMusic === 'true';
      menuMusicToggle.checked = menuMusicEnabled;
    }
    
    if (savedGameMusic !== null) {
      gameMusicEnabled = savedGameMusic === 'true';
      gameMusicToggle.checked = gameMusicEnabled;
    }
    
    if (savedVibration !== null) {
      vibrationEnabled = savedVibration === 'true';
      vibrationToggle.checked = vibrationEnabled;
    }
    
    if (savedFPSLimit) {
      fpsLimit = parseInt(savedFPSLimit);
      fpsSelect.value = fpsLimit;
    }
  }

  /* ------------------ –û–±—Ä–æ–±–Ω–∏–∫–∏ –ø–æ–¥—ñ–π –ì–†–ò ------------------ */
  addEventListener('keydown', e => {
    const key = e.key.toLowerCase();
    keys[key] = true;
    // –î–ª—è —Å—Ç—Ä—ñ–ª–æ–∫ –∑–±–µ—Ä—ñ–≥–∞—î–º–æ —ñ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è
    if (e.key.includes('Arrow')) {
        keys[e.key] = true;
    }
    
    if(e.key === 'Escape' && isGameActive && !isGameOverAnim && !waitingForRevival){ 
        togglePause();
    }
  });

  addEventListener('keyup', e => {
    const key = e.key.toLowerCase();
    keys[key] = false;
    // –î–ª—è —Å—Ç—Ä—ñ–ª–æ–∫ –≤–∏–¥–∞–ª—è—î–º–æ —ñ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–µ –∑–Ω–∞—á–µ–Ω–Ω—è
    if (e.key.includes('Arrow')) {
        keys[e.key] = false;
    }
  });

  canvas.addEventListener('touchstart',e=>{
    if(isGamePaused || waitingForRevival) return; 
    const t=e.touches[0]; joystick.active=true; joystick.x=t.clientX; joystick.y=t.clientY; joystick.dx=0; joystick.dy=0;
  });
  canvas.addEventListener('touchmove',e=>{
    if(!joystick.active || isGamePaused || waitingForRevival) return;
    const t=e.touches[0];
    const dx=t.clientX-joystick.x;
    const dy=t.clientY-joystick.y;
    const len=Math.hypot(dx,dy);
    const max=40;
    joystick.dx=(len>max?dx/len:dx/max);
    joystick.dy=(len>max?dy/len:dy/max);
  });
  canvas.addEventListener('touchend',()=>{joystick.active=false;});

  // –û–±—Ä–æ–±–Ω–∏–∫–∏ –ø–æ–¥—ñ–π –¥–ª—è –ø—Ä–∏–º—É—Å–æ–≤–æ–≥–æ –∑–∞–ø—É—Å–∫—É –º—É–∑–∏–∫–∏
  document.addEventListener('click', forcePlayMusic);
  document.addEventListener('keydown', forcePlayMusic);
  document.addEventListener('touchstart', forcePlayMusic);

  // –ó—É–ø–∏–Ω–∫–∞ –º—É–∑–∏–∫–∏ –ø—Ä–∏ –∑–º—ñ–Ω—ñ –≤–∫–ª–∞–¥–∫–∏
  document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
      stopAllMusic();
    } else {
      // –ü—Ä–∏ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—ñ –Ω–∞ –≤–∫–ª–∞–¥–∫—É - –≤—ñ–¥—Ç–≤–æ—Ä—é—î–º–æ –º—É–∑–∏–∫—É
      setTimeout(forcePlayMusic, 100);
    }
  });

  // –ó—É–ø–∏–Ω–∫–∞ –º—É–∑–∏–∫–∏ –ø—Ä–∏ –∑–∞–∫—Ä–∏—Ç—Ç—ñ –≤—ñ–∫–Ω–∞
  window.addEventListener('beforeunload', stopAllMusic);

  /* ------------------ –û–±—Ä–æ–±–Ω–∏–∫–∏ –ø–æ–¥—ñ–π –ö–ù–û–ü–û–ö ------------------ */
  startBtn.addEventListener('click', () => { showScreen('game'); startGame(); });
  retryBtn.addEventListener('click', () => { showScreen('game'); startGame(); });
  menuBtn.addEventListener('click', () => { resetGameState(); showScreen('menu'); });
  pauseBtn.addEventListener('click', togglePause);
  resumeBtn.addEventListener('click', togglePause);
  pauseMenuBtn.addEventListener('click', () => { resetGameState(); showScreen('menu'); });
  botBtn.addEventListener('click', toggleBot);
  settingsBtn.addEventListener('click', openSettings);
  closeSettingsBtn.addEventListener('click', closeSettings);
  exportBtn.addEventListener('click', exportRecords);
  importBtn.addEventListener('click', importRecords);
  closeQuestsModal.addEventListener('click', () => { questsModal.style.display = 'none'; });
  reviveBtn.addEventListener('click', performRevival);
  skipRevivalBtn.addEventListener('click', cancelRevival);
  
  // WebRTC –æ–±—Ä–æ–±–Ω–∏–∫–∏ (—Å–ø—Ä–æ—â–µ–Ω–∞ –≤–µ—Ä—Å—ñ—è)
  onlineBtn.addEventListener('click', () => { 
    rtcModal.style.display = 'flex'; 
    initSimpleWebRTC();
  });
  closeRtc.addEventListener('click', () => { 
    rtcModal.style.display = 'none'; 
    showMainPanel();
  });
  createRoomBtn.addEventListener('click', createSimpleHost);
  joinRoomMainBtn.addEventListener('click', showJoinPanel);
  copyRoomCodeBtn.addEventListener('click', copyRoomCodeToClipboard);
  startGameAsHostBtn.addEventListener('click', () => {
    if (isConnected) {
      rtcModal.style.display = 'none';
      showScreen('game');
      startGame();
    } else {
      alert('–°–ø–æ—á–∞—Ç–∫—É —á–µ–∫–∞–π—Ç–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥—Ä—É–≥–æ–≥–æ –≥—Ä–∞–≤—Ü—è!');
    }
  });
  joinRoomBtn.addEventListener('click', joinSimpleRoom);
  sendTestBtn.addEventListener('click', testConnection);
  disconnectBtn.addEventListener('click', disconnectWebRTC);
  
  // –û–±—Ä–æ–±–Ω–∏–∫ –≤–≤–µ–¥–µ–Ω–Ω—è –∫–æ–¥—É
  joinCodeInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      joinSimpleRoom();
    }
  });
  
  resetBtn.addEventListener('click', () => { 
    if(confirm('–í–∏ —Ç–æ—á–Ω–æ —Ö–æ—á–µ—Ç–µ —Å–∫–∏–Ω—É—Ç–∏ –ø—Ä–æ–≥—Ä–µ—Å?')){ 
      localStorage.removeItem('bestTime'); 
      localStorage.removeItem('bestScore');
      localStorage.removeItem('coins');
      localStorage.removeItem('quests');
      best=0; 
      bestScore=0;
      coinsAmount = 0;
      updateCoinsDisplay();
      updateCounters();
      alert('–ü—Ä–æ–≥—Ä–µ—Å —Å–∫–∏–Ω—É—Ç–æ!'); 
    } 
  });

  const showHelpAlert = () => {
    const t = translations[currentLanguage];
    alert(currentLanguage === 'uk' ? 
`üéÆ –Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è –¥–æ –≥—Ä–∏

üïπ –ù–∞ —Ç–µ–ª–µ—Ñ–æ–Ω—ñ: –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ –¥–∂–æ–π—Å—Ç–∏–∫ –¥–ª—è —Ä—É—Ö—É —Å–∏–Ω—å–æ–≥–æ –∫–≤–∞–¥—Ä–∞—Ç–∞.
‚å®Ô∏è –ù–∞ –ü–ö: —Å—Ç—Ä—ñ–ª–∫–∏ –∞–±–æ W/A/S/D. Esc –¥–ª—è –ü–∞—É–∑–∏.
üî• –ú–µ—Ç–∞: –ø—Ä–æ—Ç—Ä–∏–º–∞—Ç–∏—Å—è —è–∫–æ–º–æ–≥–∞ –¥–æ–≤—à–µ.
‚≠ê –ë–æ–Ω—É—Å–∏: 
  - –ñ–æ–≤—Ç—ñ: +100 –æ—á–æ–∫
  - –ë–ª–∞–∫–∏—Ç–Ω—ñ: +5 —Å–µ–∫—É–Ω–¥
  - –§—ñ–æ–ª–µ—Ç–æ–≤—ñ: Slow Motion (—Å–ø–æ–≤—ñ–ª—å–Ω—é—î –≤–æ—Ä–æ–≥—ñ–≤)
  - –ë—ñ—Ä—é–∑–æ–≤—ñ: Shield (–∑–∞—Ö–∏—Å—Ç –≤—ñ–¥ –æ–¥–Ω–æ–≥–æ —É–¥–∞—Ä—É –Ω–∞ 20—Å)
  - –ñ–æ–≤—Ç—ñ –≤–µ–ª–∏–∫—ñ: Speed Boost (–∑–±—ñ–ª—å—à—É—î —à–≤–∏–¥–∫—ñ—Å—Ç—å)

ü™ô –ú–æ–Ω–µ—Ç–∏: –∑–±–∏—Ä–∞–π—Ç–µ –∑–æ–ª–æ—Ç—ñ –º–æ–Ω–µ—Ç–∏ –¥–ª—è –≤—ñ–¥—Ä–æ–¥–∂–µ–Ω–Ω—è
üîÑ –í—ñ–¥—Ä–æ–¥–∂–µ–Ω–Ω—è: –ø—ñ—Å–ª—è —Å–º–µ—Ä—Ç—ñ –º–æ–∂–Ω–∞ –≤—ñ–¥—Ä–æ–¥–∏—Ç–∏—Å—è –∑–∞ –º–æ–Ω–µ—Ç–∏
üéØ –ö–≤–µ—Å—Ç–∏: –¥–æ—Å—Ç—É–ø–Ω—ñ —É –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ñ–π –≤–µ—Ä—Å—ñ—ó –≥—Ä–∏ (PWA/APK)

–ù–∞ –ü–ö/–Ω–æ—É—Ç–±—É—Ü—ñ –¥–æ—Å—Ç—É–ø–Ω–∏–π —Ä–µ–∂–∏–º –¥–ª—è –¥–≤–æ—Ö –≥—Ä–∞–≤—Ü—ñ–≤

ü§ñ –ë–æ—Ç: —á–µ—Ä–≤–æ–Ω–∏–π –∫–≤–∞–¥—Ä–∞—Ç, —è–∫–∏–π –ø–µ—Ä–µ—Å–ª—ñ–¥—É—î –≥—Ä–∞–≤—Ü—è

üí° Power-up'–∏ –∑'—è–≤–ª—è—é—Ç—å—Å—è –∫–æ–∂–Ω—ñ 10 —Å–µ–∫—É–Ω–¥!

üîó –û–Ω–ª–∞–π–Ω –≥—Ä–∞ (–ü—Ä–æ—Å—Ç–∞ –≤–µ—Ä—Å—ñ—è):
1. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å "–û–Ω–ª–∞–π–Ω" –≤ –º–µ–Ω—é
2. –•–æ—Å—Ç: –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å "–°—Ç–≤–æ—Ä–∏—Ç–∏ –∫—ñ–º–Ω–∞—Ç—É", –∑–∞–ø–∞–º'—è—Ç–∞–π—Ç–µ 6-–∑–Ω–∞—á–Ω–∏–π –∫–æ–¥
3. –î–∞–π—Ç–µ –∫–æ–¥ —ñ–Ω—à–æ–º—É –≥—Ä–∞–≤—Ü—é
4. –ì—ñ—Å—Ç—å: –í–≤–µ–¥—ñ—Ç—å –∫–æ–¥ —É –ø–æ–ª–µ —Ç–∞ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å "–ü—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—å"
5. –ß–µ–∫–∞–π—Ç–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è
6. –ü–æ—á–∏–Ω–∞–π—Ç–µ –≥—Ä—É –æ–¥–Ω–æ—á–∞—Å–Ω–æ!` : 
`üéÆ Game Instructions

üïπ On phone: use joystick to move the blue square.
‚å®Ô∏è On PC: arrows or W/A/S/D. Esc for Pause.
üî• Goal: survive as long as possible.
‚≠ê Bonuses: 
  - Yellow: +100 points
  - Blue: +5 seconds
  - Purple: Slow Motion (slows enemies)
  - Teal: Shield (protection from one hit for 20s)
  - Large Yellow: Speed Boost (increases speed)

ü™ô Coins: collect gold coins for revivals
üîÑ Revival: after death you can revive for coins
üéØ Quests: available in installed version (PWA/APK)

On PC/Laptop, a two-player mode is available

ü§ñ Bot: red square that chases the player

üí° Power-ups appear every 10 seconds!

üîó Online Game (Simple Version):
1. Click "Online" in menu
2. Host: Click "Create Room", remember the 6-digit code
3. Give the code to another player
4. Guest: Enter the code and click "Join"
5. Wait for automatic connection
6. Start the game simultaneously!`);
  };

  // ------------------ –õ–û–ì–Ü–ö–ê –ö–û–ù–°–û–õ–Ü –¢–ê LONG-PRESS ------------------
  
  function getFullHTMLCode() {
      return "<!doctype html>\n" + document.documentElement.outerHTML;
  }

  function consoleLog(text,type='info'){
    const time=new Date().toLocaleTimeString();
    const el=document.createElement('div'); el.style.padding='3px 0';
    if(type==='error') el.style.color='#ff8080';
    else if(type==='success') el.style.color='#80ffaa';
    else el.style.color='#ccc';
    el.textContent=`[${time}] ${text}`; consoleBody.appendChild(el); consoleBody.scrollTop=consoleBody.scrollHeight;
  }
  
  function closeHelpModalHandler(){
      helpModal.style.display = 'none';
      if (helpTimeoutId) {
          clearTimeout(helpTimeoutId);
          helpTimeoutId = null;
      }
  }

  function showHelpModal(){
      if (helpTimeoutId) clearTimeout(helpTimeoutId);

      helpModal.style.display = 'block';

      helpTimeoutId = setTimeout(closeHelpModalHandler, 5000); 
  }

  function closeConsole(){
      consoleOverlay.style.display='none'; 
      consoleOverlay.setAttribute('aria-hidden','true');
  }

  function handleCommand(raw){
    if(!raw||raw.trim()==='') return;
    const parts=raw.trim().split(/\s+/), cmd=parts[0].toLowerCase(), args=parts.slice(1);
    consoleLog('> '+raw,'info');
    switch(cmd){
      case '/help':
        showHelpModal(); 
        break;
      case '/code':
        {
            const password = prompt('–í–≤–µ–¥—ñ—Ç—å –ø–∞—Ä–æ–ª—å –¥–ª—è –¥–æ—Å—Ç—É–ø—É –¥–æ –∫–æ–¥—É:'); 
            if (password === SECURE_PASSWORD) {
                codePre.textContent = getFullHTMLCode(); 
                codeModal.style.display = 'flex'; 
                consoleLog('Access granted. Code shown.','success'); 
            } else {
                consoleLog('Access denied. Incorrect password.','error');
            }
        }
        break;
      case '/god':{
        const mode=args[0]&&args[0].toLowerCase();
        if(mode==='on'){ godMode=true; consoleLog('God mode ON','success'); }
        else if(mode==='off'){ godMode=false; consoleLog('God mode OFF','success'); }
        else consoleLog('Usage: /god on|off','error');
        break;
      }
      case '/score':
        consoleLog(`–ü–æ—Ç–æ—á–Ω–∏–π —Ä–∞—Ö—É–Ω–æ–∫: ${score}${twoPlayerMode ? ` | –ì—Ä–∞–≤–µ—Ü—å 2: ${score2}` : ''}`,'success');
        break;
      case '/time':
        consoleLog(`–ß–∞—Å –≥—Ä–∏: ${timeSec} —Å–µ–∫—É–Ω–¥`,'success');
        break;
      case '/clear':
        consoleBody.innerHTML = '';
        consoleLog('–ö–æ–Ω—Å–æ–ª—å –æ—á–∏—â–µ–Ω–∞','success');
        break;
      case '/enemies':
        consoleLog(`–ê–∫—Ç–∏–≤–Ω–∏—Ö –≤–æ—Ä–æ–≥—ñ–≤: ${enemies.length}`,'info');
        break;
      case '/bot':{
        const mode=args[0]&&args[0].toLowerCase();
        if(mode==='on'){ 
          botEnabled=true; 
          updateBotButton();
          consoleLog('–ë–æ—Ç —É–≤—ñ–º–∫–Ω–µ–Ω–∏–π','success'); 
        }
        else if(mode==='off'){ 
          botEnabled=false; 
          updateBotButton();
          consoleLog('–ë–æ—Ç –≤–∏–º–∫–Ω–µ–Ω–∏–π','success'); 
        }
        else consoleLog('Usage: /bot on|off','error');
        break;
      }
      case '/bb':{
        const mode=args[0]&&args[0].toLowerCase();
        if(mode==='on'){ 
          bodyguardBot.active=true; 
          consoleLog('–ë–æ—Ç-–æ—Ö–æ—Ä–æ–Ω–µ—Ü—å —É–≤—ñ–º–∫–Ω–µ–Ω–∏–π','success'); 
        }
        else if(mode==='off'){ 
          bodyguardBot.active=false; 
          consoleLog('–ë–æ—Ç-–æ—Ö–æ—Ä–æ–Ω–µ—Ü—å –≤–∏–º–∫–Ω–µ–Ω–∏–π','success'); 
        }
        else consoleLog('Usage: /bb on|off','error');
        break;
      }
      case '/coins':
        consoleLog(`–ú–æ–Ω–µ—Ç–∏: ${coinsAmount} ü™ô`, 'success');
        break;
      case '/addcoins':{
        const amount = parseInt(args[0]) || 1;
        addCoin(amount);
        consoleLog(`–î–æ–¥–∞–Ω–æ ${amount} –º–æ–Ω–µ—Ç(—É)`, 'success');
        break;
      }
      case '/twoplayer':{
        const mode=args[0]&&args[0].toLowerCase();
        if(mode==='on'){ 
          toggleTwoPlayerMode();
        }
        else if(mode==='off'){ 
          toggleTwoPlayerMode();
        }
        else consoleLog('Usage: /twoplayer on|off','error');
        break;
      }
      case '/level':
        consoleLog(`–ü–æ—Ç–æ—á–Ω–∏–π —Ä—ñ–≤–µ–Ω—å: ${level}`, 'info');
        break;
      case '/quests':
        openQuests();
        break;
      case '/fps':
        consoleLog(`–ü–æ—Ç–æ—á–Ω–∏–π FPS: ${fps}, –õ—ñ–º—ñ—Ç: ${fpsLimit}`, 'info');
        break;
      case '/online':
        rtcModal.style.display = 'flex';
        initSimpleWebRTC();
        break;
      case '/rtcstatus':
        consoleLog(`WebRTC —Å—Ç–∞—Ç—É—Å: ${isConnected ? '–ü—ñ–¥–∫–ª—é—á–µ–Ω–æ' : '–ù–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ'} ${isHost ? '(–•–æ—Å—Ç)' : '(–ì—ñ—Å—Ç—å)'}`, 'info');
        break;
      case '/rtcping':
        testConnection();
        break;
      case '/rtcdisconnect':
        disconnectWebRTC();
        consoleLog('WebRTC –≤—ñ–¥–∫–ª—é—á–µ–Ω–æ', 'success');
        break;
      default: consoleLog('Unknown command. Type /help for assistance.','error');
    }
  }

  consoleSend.addEventListener('click', () => { 
    handleCommand(consoleInput.value); 
    consoleInput.value=''; 
    consoleInput.focus(); 
  });
  
  consoleInput.addEventListener('keydown', e => { 
    if(e.key==='Enter'){ 
      e.preventDefault(); 
      handleCommand(consoleInput.value); 
      consoleInput.value=''; 
    } 
  });
  
  closeConsoleBtn.addEventListener('click', closeConsole); 
  consoleBackBtn.addEventListener('click', closeConsole); 
  closeCodeModal.addEventListener('click', () => { codeModal.style.display='none'; }); 
  closeHelpModal.addEventListener('click', closeHelpModalHandler); 

  let holdTimer = null;
  const HOLD_MS = 2000; 

  function openConsole(){
    consoleOverlay.style.display = 'flex';
    consoleOverlay.setAttribute('aria-hidden','false');
    consoleInput.focus();
    consoleStatus.textContent = 'system active'; 
  }

  function startHoldTimer(e){
    e.preventDefault(); 
    if(holdTimer) clearTimeout(holdTimer);
    
    holdTimer = setTimeout(()=>{ 
      openConsole(); 
      holdTimer = null; 
      consoleLog('–ö–æ–Ω—Å–æ–ª—å –≤—ñ–¥–∫—Ä–∏—Ç–æ. –í–≤–µ–¥—ñ—Ç—å /help –¥–ª—è –¥–æ–≤—ñ–¥–∫–∏.','success'); 
    }, HOLD_MS);
  }

  function cancelHoldTimer(e){
    if(holdTimer){ 
      clearTimeout(holdTimer);
      if(e.type === 'mouseup' || e.type === 'touchend') {
        showHelpAlert(); 
      }
      holdTimer = null;
    }
  }

  howBtn.addEventListener('mousedown', startHoldTimer);
  howBtn.addEventListener('mouseup', cancelHoldTimer);
  howBtn.addEventListener('mouseleave', () => { 
    if(holdTimer) clearTimeout(holdTimer);
    holdTimer = null;
  });
  howBtn.addEventListener('touchstart', startHoldTimer, {passive:false});
  howBtn.addEventListener('touchend', cancelHoldTimer);

  /* ------------------ –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è ------------------ */
  consoleStatus.textContent = 'system ready'; 
  
  // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å
  loadSettings();
  checkPWA();
  loadQuests();
  
  // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –º–æ–Ω–µ—Ç
  coinsAmount = parseInt(localStorage.getItem('coins')) || 0;
  updateCoinsDisplay();
  
  // –°—Ç–≤–æ—Ä—é—î–º–æ –∫–Ω–æ–ø–∫—É –¥–ª—è –¥–≤–æ—Ö –≥—Ä–∞–≤—Ü—ñ–≤ –¥–∏–Ω–∞–º—ñ—á–Ω–æ
  const buttonsContainer = document.querySelector('#menu .buttons');
  if (buttonsContainer) {
    twoPlayerBtn = document.createElement('button');
    twoPlayerBtn.id = 'twoPlayerBtn';
    twoPlayerBtn.className = 'two-player-btn';
    twoPlayerBtn.textContent = translations[currentLanguage].twoPlayerBtnOff;
    
    // –í—Å—Ç–∞–≤–ª—è—î–º–æ –ø—ñ—Å–ª—è –∫–Ω–æ–ø–∫–∏ –±–æ—Ç–∞
    botBtn.parentNode.insertBefore(twoPlayerBtn, botBtn.nextSibling);
    
    // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫ –ø–æ–¥—ñ—ó
    twoPlayerBtn.addEventListener('click', toggleTwoPlayerMode);
    
    // –ü—Ä–∏—Ö–æ–≤—É—î–º–æ –∫–Ω–æ–ø–∫—É –Ω–∞ –º–æ–±—ñ–ª—å–Ω–∏—Ö –ø—Ä–∏—Å—Ç—Ä–æ—è—Ö
    if (isMobileDevice()) {
      twoPlayerBtn.style.display = 'none';
    }
  }
  
  // –°—Ç–≤–æ—Ä—é—î–º–æ –∫–Ω–æ–ø–∫—É –∫–≤–µ—Å—Ç—ñ–≤ –¥–∏–Ω–∞–º—ñ—á–Ω–æ
  if (buttonsContainer) {
    questsBtn.style.display = 'none'; // –ü–æ—á–∞—Ç–∫–æ–≤–æ –ø—Ä–∏—Ö–æ–≤–∞–Ω–∞
    
    // –ü–µ—Ä–µ–º—ñ—â—É—î–º–æ –∫–Ω–æ–ø–∫—É –ø—ñ—Å–ª—è –∫–Ω–æ–ø–∫–∏ –¥–≤–æ—Ö –≥—Ä–∞–≤—Ü—ñ–≤
    if (twoPlayerBtn) {
      twoPlayerBtn.parentNode.insertBefore(questsBtn, twoPlayerBtn.nextSibling);
    }
  }
  
  // –°–ø—Ä–æ–±–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ –≤—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è –º—É–∑–∏–∫–∏
  setTimeout(() => {
    if (menuMusicEnabled) {
      playMenuMusic();
    }
  }, 500);
  
  updateBotButton();
  updateTwoPlayerButton();
  updateCounters();
  updateLanguage();
  showScreen('menu');
  resize();
})();

// –ì–ª–æ–±–∞–ª—å–Ω–∞ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è Shift+B
const consoleOverlay = document.getElementById("consoleOverlay");
let consoleOpen = false;

document.addEventListener("keydown", (e) => {
    if (e.shiftKey && e.key.toLowerCase() === "b") {
        consoleOpen = !consoleOpen;

        if (consoleOpen) {
            consoleOverlay.style.display = "block";

            // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥—É –∫–æ–Ω—Å–æ–ª—ñ
            const input = document.getElementById("consoleInput");
            if (input) setTimeout(() => input.focus(), 50);

        } else {
            consoleOverlay.style.display = "none";
        }
    }
});
</script>
</body>
</html>